{% extends "layout.html" %}

{% block content %}
<style>
    /* [ê²Œì„ ì˜ì—­ ìŠ¤íƒ€ì¼] */
    .play-area {
        background: #34495e;
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #2c3e50;
        
        line-height: 1.8;
        font-size: 1.1rem;
        letter-spacing: -0.5px;
        word-spacing: -1px;
        
        text-align: left;
        word-break: keep-all;
        color: #ecf0f1;
    }

    .edit-token {
        cursor: pointer; padding: 1px 3px; border-radius: 4px; border: 1px solid transparent; transition: 0.2s; display: inline-block;
    }
    .edit-token:hover { background: rgba(243, 156, 18, 0.2); border-color: #f39c12; }
    .edit-token.selected { background: #e74c3c; color: #fff; font-weight: bold; box-shadow: 0 2px 0 #c0392b; transform: translateY(-1px); }
    
    .static-text { color: #bdc3c7; font-weight: normal; margin: 0; }

    .quiz-input {
        background: #2c3e50; border: none; border-bottom: 2px solid #7f8c8d; color: #f1c40f; text-align: center;
        font-size: 1.1rem; font-weight: bold; padding: 0; margin: 0 2px; height: 1.4rem;
        font-family: 'Jua', sans-serif; transition: 0.2s; max-width: 100%;
    }
    .quiz-input:focus { outline: none; border-bottom-color: #f1c40f; background: #233140; }
    .quiz-input.correct { border-bottom-color: #2ecc71; color: #2ecc71; background: transparent; }
    .quiz-input.error { border-bottom-color: #e74c3c; color: #e74c3c; background: rgba(231, 76, 60, 0.1); animation: shake 0.3s; }

    .answer-hint {
        display: none; position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
        background: #e74c3c; color: white; padding: 2px 6px; border-radius: 6px; 
        font-size: 0.8rem; white-space: nowrap; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 1px solid white;
    }
    .input-wrapper { position: relative; display: inline-block; }
    .input-wrapper.show-hint .answer-hint { display: block; }

    .btn-action {
        width: 100%; padding: 12px; font-size: 1.2rem; font-family: 'Black Han Sans';
        border: none; border-radius: 10px; cursor: pointer; margin-top: 20px; transition: 0.2s;
    }
    .btn-blue { background: #3498db; color: white; box-shadow: 0 4px 0 #2980b9; }
    .btn-blue:hover { transform: translateY(2px); box-shadow: 0 2px 0 #2980b9; }

    /* ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ (ì´ˆë¡ìƒ‰) */
    .btn-next {
        background: #27ae60; color: white; box-shadow: 0 4px 0 #219150; margin-top: 10px;
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
    }
    .btn-next:hover { transform: translateY(2px); box-shadow: 0 2px 0 #219150; }

    @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-3px);} 75%{transform:translateX(3px);} }

    @media (max-width: 768px) {
        .play-area { font-size: 1rem; line-height: 1.6; padding: 15px; }
        .quiz-input { font-size: 1rem; max-width: 100px; }
    }
</style>

<div style="text-align: center;">
    {% if edit_mode %}
        <h3 style="color: #f39c12; margin-top:0;">âœï¸ ë¹ˆì¹¸ ë§Œë“¤ê¸°</h3>
        <p style="color:#bdc3c7; font-size:0.9rem; margin-bottom:15px;">
            ë‹¨ì–´ë¥¼ í„°ì¹˜í•˜ì—¬ ë¹ˆì¹¸ì„ ë§Œë“œì„¸ìš”.
        </p>

        <div id="edit-board" class="play-area"></div>

        <form method="POST" id="edit-form">
            <input type="hidden" name="edited_content" id="edited_content">
            <button type="button" class="btn-action btn-blue" onclick="submitEdit()">
                ì‘ì „ ê°œì‹œ ğŸš€
            </button>
        </form>

    {% else %}
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <a href="/dungeon" style="text-decoration:none; color:#bdc3c7; font-size:1rem;">ğŸ”™ ë’¤ë¡œ</a>
            <div style="font-size:1.2rem; color:#f1c40f; font-weight:bold;">EXP: <span id="xp-display">{{ session['xp'] }}</span></div>
        </div>

        <div class="play-area" id="game-board">
            {% for part in parts %}
                {% if part.type == 'text' %}
                    <span class="static-text">{{ part.val | replace("â‘ ", "<br>â‘ ") | replace("â‘¡", "<br>â‘¡") | replace("â‘¢", "<br>â‘¢") | replace("â‘£", "<br>â‘£") | replace("â‘¤", "<br>â‘¤") | safe }}</span>
                {% else %}
                    <span class="input-wrapper">
                        <span class="answer-hint">{{ targets[part.id] }}</span>
                        <input type="text" class="quiz-input" 
                               data-answer="{{ targets[part.id] }}" 
                               style="width:{{ targets[part.id]|length * 12 + 10 }}px;" 
                               autocomplete="off">
                    </span>
                {% endif %}
            {% endfor %}
        </div>

        <form method="POST" id="game-form">
            <input type="hidden" name="penalty_count" id="penalty_count" value="0">
        </form>
        
        <button id="submit-btn" class="btn-action" onclick="checkFinal()" disabled 
                style="background:#7f8c8d; color:#bdc3c7; cursor:not-allowed; box-shadow:none;">
            ë¹ˆì¹¸ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”
        </button>

        {% if next_quest %}
        <form action="/dungeon" method="POST" style="margin:0;">
            <input type="hidden" name="quest_select" value="{{ next_quest }}">
            <button id="next-btn" class="btn-action btn-next">
                â© ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™
            </button>
        </form>
        {% endif %}

    {% endif %}
</div>

<script>
    {% if edit_mode %}
        const rawContent = `{{ raw_content | safe }}`;
        const editBoard = document.getElementById('edit-board');
        let tokenList = []; 

        function parseText(text) {
            const paragraphs = text.split('\n');
            let html = '';
            tokenList = [];

            paragraphs.forEach(para => {
                if (!para.trim()) return;
                html += '<div style="margin-bottom:10px;">';
                const chunks = para.split(/\s+/);
                
                chunks.forEach(chunk => {
                    const subTokens = chunk.split(/([^ê°€-í£a-zA-Z0-9]+)/);
                    subTokens.forEach(token => {
                        if (!token) return;
                        const isWord = /[ê°€-í£a-zA-Z0-9]/.test(token);
                        if (!isWord) {
                            tokenList.push({ text: token, type: 'static', selected: false });
                            html += `<span class="static-text">${token}</span>`;
                        } else {
                            let core = token;
                            let suffix = "";
                            const particles = ['ìœ¼ë¡œ', 'ì—ì„œ', 'ë¶€í„°', 'ê¹Œì§€', 'ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì˜', 'ì™€', 'ê³¼', 'ë¡œ', 'ë„', 'ë§Œ'];
                            for (let p of particles) {
                                if (core.endsWith(p) && core.length > p.length) {
                                    suffix = p; core = core.substring(0, core.length - p.length); break;
                                }
                            }
                            const idx = tokenList.length;
                            tokenList.push({ text: core, type: 'word', selected: false });
                            html += `<span class="edit-token" onclick="toggleToken(${idx}, this)">${core}</span>`;
                            if (suffix) {
                                tokenList.push({ text: suffix, type: 'static', selected: false });
                                html += `<span class="static-text">${suffix}</span>`;
                            }
                        }
                    });
                    tokenList.push({ text: ' ', type: 'space', selected: false });
                    html += ' '; 
                });
                html += '</div>';
            });
            editBoard.innerHTML = html;
        }

        function toggleToken(idx, el) {
            const token = tokenList[idx];
            token.selected = !token.selected;
            if (token.selected) el.classList.add('selected');
            else el.classList.remove('selected');
        }

        function submitEdit() {
            let result = "";
            tokenList.forEach(t => {
                if (t.type === 'word' && t.selected) { result += `{${t.text}}`; } else { result += t.text; }
            });
            document.getElementById('edited_content').value = result;
            document.getElementById('edit-form').submit();
        }
        parseText(rawContent);

    {% else %}
        const inputs = document.querySelectorAll('.quiz-input');
        const xpDisplay = document.getElementById('xp-display');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        let currentXP = {{ session['xp'] }};
        let penaltyCount = 0;

        inputs.forEach(input => {
            input.addEventListener('change', function() { validate(this); checkAll(); });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { this.blur(); focusNext(this); }
            });
        });

        function validate(input) {
            const val = input.value.trim();
            const ans = input.dataset.answer;
            const wrapper = input.parentElement;

            if (input.classList.contains('correct')) return;
            if (val === '') {
                input.classList.remove('error');
                wrapper.classList.remove('show-hint');
                return;
            }

            if (val === ans) {
                input.classList.remove('error');
                input.classList.add('correct');
                input.readOnly = true;
                wrapper.classList.remove('show-hint');
                updateXP(5);
            } else {
                input.classList.add('error');
                wrapper.classList.add('show-hint');
                updateXP(-5);
                penaltyCount++;
                document.getElementById('penalty_count').value = penaltyCount;
            }
        }

        function updateXP(amount) {
            currentXP += amount;
            xpDisplay.innerText = currentXP;
            const effect = document.createElement('span');
            effect.innerText = amount > 0 ? `+${amount}` : amount;
            effect.style.position = 'fixed';
            effect.style.color = amount > 0 ? '#2ecc71' : '#e74c3c';
            effect.style.fontWeight = 'bold';
            effect.style.fontSize = '1.5rem';
            effect.style.textShadow = '1px 1px 0 #000';
            effect.style.zIndex = '9999';
            const rect = xpDisplay.getBoundingClientRect();
            effect.style.left = rect.left + 'px';
            effect.style.top = (rect.top - 30) + 'px';
            effect.style.transition = '1s';
            document.body.appendChild(effect);
            setTimeout(() => { effect.style.top = (rect.top - 80) + 'px'; effect.style.opacity = 0; }, 50);
            setTimeout(() => effect.remove(), 1000);
        }

        function checkAll() {
            const allCorrect = Array.from(inputs).every(i => i.classList.contains('correct'));
            if (allCorrect) {
                submitBtn.disabled = false;
                submitBtn.style.background = "#2ecc71";
                submitBtn.style.color = "white";
                submitBtn.style.cursor = "pointer";
                submitBtn.style.boxShadow = "0 4px 0 #27ae60";
                submitBtn.innerText = "ğŸ‰ ë¯¸ì…˜ ì„±ê³µ! ë³´ìƒ íšë“";
                
                // [ì‹ ê·œ] ë‹¤ ë§ì¶”ë©´ ë‹¤ìŒ ë²„íŠ¼ ë³´ì´ê¸°
                if (nextBtn) {
                    nextBtn.style.display = "block";
                }
            }
        }

        function checkFinal() {
            document.getElementById('game-form').submit();
        }

        function focusNext(curr) {
            const arr = Array.from(inputs);
            const idx = arr.indexOf(curr);
            if (idx < arr.length - 1) {
                for(let i=idx+1; i<arr.length; i++){
                    if(!arr[i].readOnly) { arr[i].focus(); break; }
                }
            }
        }
    {% endif %}
</script>
{% endblock %}
