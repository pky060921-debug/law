{% extends "layout.html" %}

{% block content %}
<style>
    /* [ë°˜ì‘í˜• ê²Œì„ ë³´ë“œ] */
    .play-area {
        background: #34495e;
        padding: 30px;
        border-radius: 15px;
        border: 2px solid #2c3e50;
        
        /* PC ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        line-height: 2.5; 
        font-size: 1.3rem; 
        text-align: left;
        word-break: keep-all;
        color: #ecf0f1;
    }

    .edit-token {
        cursor: pointer; padding: 2px 5px; border-radius: 4px; border: 1px solid transparent; display: inline-block;
    }
    .edit-token:hover { background: rgba(243, 156, 18, 0.2); border-color: #f39c12; }
    .edit-token.selected { background: #e74c3c; color: #fff; font-weight: bold; }
    
    .static-text { color: #bdc3c7; font-weight: normal; }

    /* ë°˜ì‘í˜• ì…ë ¥ì°½ */
    .quiz-input {
        background: #2c3e50; border: none; border-bottom: 2px solid #7f8c8d; color: #f1c40f; text-align: center;
        font-size: 1.3rem; font-weight: bold; padding: 0; margin: 0 2px;
        font-family: 'Jua', sans-serif; transition: 0.2s; 
        min-width: 30px; max-width: 100%;
    }
    .quiz-input:focus { outline: none; border-bottom-color: #f1c40f; background: #233140; }
    .quiz-input.correct { border-bottom-color: #2ecc71; color: #2ecc71; background: transparent; }
    .quiz-input.error { border-bottom-color: #e74c3c; color: #e74c3c; animation: shake 0.3s; }

    .btn-action {
        width: 100%; padding: 15px; font-size: 1.2rem; font-family: 'Black Han Sans';
        border: none; border-radius: 10px; cursor: pointer; margin-top: 20px;
    }
    .btn-blue { background: #3498db; color: white; }
    .btn-next { background: #27ae60; color: white; margin-top: 10px; display: none; }

    /* ğŸ“± íƒœë¸”ë¦¿/ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 1024px) {
        .play-area {
            font-size: 1.1rem; /* ê¸€ì”¨ ì¤„ì„ */
            line-height: 2.0;  /* ì¤„ê°„ê²© ì¢í˜ */
            padding: 20px;
        }
        .quiz-input { font-size: 1.1rem; }
    }

    @media (max-width: 768px) {
        .play-area {
            font-size: 1rem;
            line-height: 1.8;
            padding: 15px;
        }
        .quiz-input { font-size: 1rem; max-width: 100px; }
    }
    
    @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-3px);} 75%{transform:translateX(3px);} }
</style>

<div style="text-align: center;">
    {% if edit_mode %}
        <h3 style="color: #f39c12;">âœï¸ ì‘ì „ ì„¤ê³„ (ë¹ˆì¹¸ ìƒì„±)</h3>
        <div id="edit-board" class="play-area"></div>
        <form method="POST" id="edit-form">
            <input type="hidden" name="edited_content" id="edited_content">
            <button type="button" class="btn-action btn-blue" onclick="submitEdit()">ì‘ì „ ê°œì‹œ ğŸš€</button>
        </form>
    {% else %}
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <a href="/dungeon" style="text-decoration:none; color:#bdc3c7; font-size:1rem;">ğŸ”™ ë’¤ë¡œ</a>
            <div style="font-size:1.2rem; color:#f1c40f; font-weight:bold;">EXP: {{ session['xp'] }}</div>
        </div>

        <div class="play-area" id="game-board">
            {% for part in parts %}
                {% if part.type == 'text' %}
                    <span class="static-text">{{ part.val | replace("â‘ ", "<br>â‘ ") | replace("â‘¡", "<br>â‘¡") | replace("â‘¢", "<br>â‘¢") | replace("â‘£", "<br>â‘£") | replace("â‘¤", "<br>â‘¤") | safe }}</span>
                {% else %}
                    <input type="text" class="quiz-input" data-answer="{{ targets[part.id] }}" 
                           style="width:{{ targets[part.id]|length * 15 + 10 }}px;" autocomplete="off">
                {% endif %}
            {% endfor %}
        </div>

        <form method="POST" id="game-form">
            <input type="hidden" name="penalty_count" id="penalty_count" value="0">
        </form>
        
        <button id="submit-btn" class="btn-action" onclick="checkFinal()" disabled style="background:#7f8c8d; cursor:not-allowed;">
            ë¹ˆì¹¸ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”
        </button>

        {% if next_quest %}
        <form action="/dungeon" method="POST" style="margin:0;">
            <input type="hidden" name="quest_select" value="{{ next_quest }}">
            <button id="next-btn" class="btn-action btn-next">â© ë‹¤ìŒ ì‘ì „ìœ¼ë¡œ ì´ë™</button>
        </form>
        {% endif %}
    {% endif %}
</div>

<script>
    {% if edit_mode %}
        const rawContent = `{{ raw_content | safe }}`;
        const editBoard = document.getElementById('edit-board');
        let tokenList = []; 
        function parseText(text) {
            const paragraphs = text.split('\n');
            let html = ''; tokenList = [];
            paragraphs.forEach(para => {
                if (!para.trim()) return;
                html += '<div style="margin-bottom:10px;">';
                const chunks = para.split(/\s+/);
                chunks.forEach(chunk => {
                    const subTokens = chunk.split(/([^ê°€-í£a-zA-Z0-9]+)/);
                    subTokens.forEach(token => {
                        if (!token) return;
                        if (/[ê°€-í£a-zA-Z0-9]/.test(token)) {
                            let core = token, suffix = "";
                            const particles = ['ìœ¼ë¡œ', 'ì—ì„œ', 'ë¶€í„°', 'ê¹Œì§€', 'ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì˜', 'ì™€', 'ê³¼', 'ë¡œ', 'ë„', 'ë§Œ'];
                            for (let p of particles) if (core.endsWith(p) && core.length > p.length) { suffix = p; core = core.substring(0, core.length - p.length); break; }
                            const idx = tokenList.length;
                            tokenList.push({ text: core, type: 'word', selected: false });
                            html += `<span class="edit-token" onclick="toggleToken(${idx}, this)">${core}</span>`;
                            if (suffix) { tokenList.push({ text: suffix, type: 'static' }); html += `<span class="static-text">${suffix}</span>`; }
                        } else {
                            tokenList.push({ text: token, type: 'static' });
                            html += `<span class="static-text">${token}</span>`;
                        }
                    });
                    tokenList.push({ text: ' ', type: 'space' }); html += ' '; 
                });
                html += '</div>';
            });
            editBoard.innerHTML = html;
        }
        function toggleToken(idx, el) {
            const token = tokenList[idx]; token.selected = !token.selected;
            el.classList.toggle('selected');
        }
        function submitEdit() {
            let result = "";
            tokenList.forEach(t => { result += (t.type === 'word' && t.selected) ? `{${t.text}}` : t.text; });
            document.getElementById('edited_content').value = result;
            document.getElementById('edit-form').submit();
        }
        parseText(rawContent);
    {% else %}
        const inputs = document.querySelectorAll('.quiz-input');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        let penaltyCount = 0;

        inputs.forEach(input => {
            input.addEventListener('change', function() { validate(this); checkAll(); });
            input.addEventListener('keydown', function(e) { if (e.key === 'Enter') { this.blur(); focusNext(this); }});
        });

        function validate(input) {
            const val = input.value.trim();
            const ans = input.dataset.answer;
            if (input.classList.contains('correct')) return;
            if (val === ans) {
                input.classList.remove('error'); input.classList.add('correct'); input.readOnly = true;
            } else if (val !== '') {
                input.classList.add('error'); penaltyCount++;
                document.getElementById('penalty_count').value = penaltyCount;
            }
        }

        function checkAll() {
            if (Array.from(inputs).every(i => i.classList.contains('correct'))) {
                submitBtn.disabled = false;
                submitBtn.style.background = "#2ecc71";
                submitBtn.style.color = "white";
                submitBtn.style.cursor = "pointer";
                submitBtn.innerText = "ğŸ‰ ë¯¸ì…˜ ì„±ê³µ! ë³´ìƒ íšë“";
                if (nextBtn) nextBtn.style.display = "block";
            }
        }
        function checkFinal() { document.getElementById('game-form').submit(); }
        function focusNext(curr) {
            const arr = Array.from(inputs);
            const idx = arr.indexOf(curr);
            for(let i=idx+1; i<arr.length; i++) if(!arr[i].readOnly) { arr[i].focus(); break; }
        }
    {% endif %}
</script>
{% endblock %}
