<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜ì „ í”Œë ˆì´</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #1a1a1a; color: #fff; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; background: #2a2a2a; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        /* ìƒë‹¨ UI */
        header { display: flex; justify-content: space-between; border-bottom: 2px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
        .xp-bar { font-size: 1.2rem; color: #4a90e2; font-weight: bold; }
        
        /* XP ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .xp-anim { position: absolute; font-weight: bold; animation: floatUp 0.8s ease-out forwards; pointer-events: none; }
        .xp-plus { color: #2ecc71; }
        .xp-minus { color: #ff6b6b; }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: #fff; transition: 0.2s; }
        .btn-submit { background: #4a90e2; width: 100%; margin-top: 20px; font-size: 1.1rem; padding: 15px; }
        .btn-submit:hover { background: #357abd; }
        .btn-submit:disabled { background: #555; cursor: not-allowed; }
        .btn-back { background: #555; }

        /* ê²Œì„ ë³´ë“œ (í…ìŠ¤íŠ¸ ì˜ì—­) */
        #game-board { line-height: 2.8; font-size: 1.15rem; text-align: left; word-break: keep-all; }
        
        /* ë‹¨ì–´ ê·¸ë£¹ (ì…ë ¥ì°½ + ì¡°ì‚¬) */
        .word-group { display: inline-block; white-space: nowrap; margin-right: 5px; position: relative; }
        .particle { color: #aaa; font-weight: normal; }
        .prefix { color: #aaa; margin-right: 2px; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        input.quiz-input {
            background: #333; border: none; border-bottom: 2px solid #555;
            color: #fff; text-align: center; font-size: 1.1rem; padding: 2px 5px;
            border-radius: 3px; outline: none; font-family: inherit;
            transition: all 0.2s;
        }
        input.quiz-input:focus { border-bottom-color: #4a90e2; background: #3a3a3a; }
        input.quiz-input:read-only { cursor: default; }
        
        /* ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ */
        input.correct { border-bottom-color: #2ecc71; background: #1e3a29; color: #2ecc71; font-weight: bold; }
        input.error { border-bottom-color: #ff6b6b; background: #3a1e1e; color: #ff6b6b; animation: shake 0.3s; }

        /* ì •ë‹µ íŒíŠ¸ (ì˜¤ë‹µì¼ ë•Œ í‘œì‹œ) */
        .answer-hint {
            display: none; position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            background: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 0.9rem; font-weight: bold; z-index: 100; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .answer-hint::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            border-width: 6px 6px 0; border-style: solid; border-color: #e74c3c transparent transparent transparent;
        }
        /* ì—ëŸ¬ ìƒíƒœì¼ ë•Œ íŒíŠ¸ ë³´ì´ê¸° */
        .word-group.show-hint .answer-hint { display: block; }

        /* í¸ì§‘ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .edit-word { cursor: pointer; padding: 2px 4px; border-radius: 4px; border: 1px solid transparent; }
        .edit-word:hover { background: #444; border-color: #666; }
        .edit-word.selected { background: #d63031; color: white; border-color: #ff7675; }
        .edit-word.selected::before { content: '{'; color: #ffcc00; }
        .edit-word.selected::after { content: '}'; color: #ffcc00; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="/dungeon" class="btn btn-back">ğŸ”™ ë‚˜ê°€ê¸°</a>
            <div class="xp-bar">EXP: <span id="xp-val">{{ session['xp'] }}</span></div>
        </header>

        {% if edit_mode %}
        <div>
            <h2 style="color: #ffd700;">âœï¸ ë¹ˆì¹¸ ë§Œë“¤ê¸°</h2>
            <p style="color:#ccc; font-size:0.9rem;">í´ë¦­í•˜ì—¬ ë¹ˆì¹¸ìœ¼ë¡œ ë§Œë“¤ í•µì‹¬ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ì¡°ì‚¬ëŠ” ìë™ìœ¼ë¡œ ë¶„ë¦¬ë©ë‹ˆë‹¤)</p>
            
            <div id="edit-board" style="background:#222; padding:20px; border-radius:10px; min-height:100px; text-align:left; line-height:2.5;"></div>

            <form method="POST" id="edit-form">
                <input type="hidden" name="edited_content" id="edited_content">
                <button type="button" class="btn btn-submit" onclick="submitEdit()">ì„¤ì • ì™„ë£Œ (ê²Œì„ ì‹œì‘)</button>
            </form>
        </div>

        <script>
            const rawContent = `{{ raw_content | safe }}`;
            const editBoard = document.getElementById('edit-board');
            let tokenData = [];

            // 1. í…ìŠ¤íŠ¸ ë¶„ë¦¬ ë¡œì§ (ì¡°ì‚¬/ë¶€í˜¸ ë–¼ì–´ë‚´ê¸°)
            function parseText(text) {
                const paragraphs = text.split('\n');
                let html = '';
                let globalIdx = 0;

                paragraphs.forEach(para => {
                    if (!para.trim()) return;
                    html += '<div style="margin-bottom:10px;">';
                    const words = para.split(/\s+/);
                    
                    words.forEach(word => {
                        const match = word.match(/^([(\[\"\'\.]*)(.+?)([)\]\"\'\,\.\?]*)$/);
                        let prefix = match ? match[1] : "";
                        let core = match ? match[2] : word;
                        let suffix = match ? match[3] : "";

                        const particles = ['ìœ¼ë¡œ', 'ì—ì„œ', 'ë¶€í„°', 'ê¹Œì§€', 'ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì˜', 'ì™€', 'ê³¼', 'ë¡œ', 'ë„', 'ë§Œ'];
                        for (let p of particles) {
                            if (core.endsWith(p) && core.length > p.length) {
                                suffix = p + suffix;
                                core = core.substring(0, core.length - p.length);
                                break;
                            }
                        }

                        tokenData.push({ prefix, core, suffix, selected: false });
                        
                        html += `<span class="word-group">`;
                        if(prefix) html += `<span class="prefix">${prefix}</span>`;
                        html += `<span class="edit-word" onclick="toggleWord(${globalIdx}, this)">${core}</span>`;
                        if(suffix) html += `<span class="particle">${suffix}</span>`;
                        html += `</span> `;
                        globalIdx++;
                    });
                    html += '</div>';
                });
                editBoard.innerHTML = html;
            }

            function toggleWord(idx, el) {
                tokenData[idx].selected = !tokenData[idx].selected;
                el.classList.toggle('selected');
            }

            function submitEdit() {
                let finalStr = tokenData.map(t => {
                    let w = t.core;
                    if(t.selected) w = `{${w}}`;
                    return `${t.prefix}${w}${t.suffix}`;
                }).join(' ');

                document.getElementById('edited_content').value = finalStr;
                document.getElementById('edit-form').submit();
            }

            parseText(rawContent);
        </script>

        {% else %}
        <div>
            <div id="game-board">
                {% for part in parts %}
                    {% if part.type == 'text' %}
                        <span>{{ part.val }}</span>
                    {% else %}
                        <span class="word-group">
                            <span class="answer-hint">{{ targets[part.id] }}</span>
                            <input type="text" class="quiz-input" 
                                   data-answer="{{ targets[part.id] }}"
                                   style="width: {{ targets[part.id]|length * 16 + 10 }}px;"
                                   autocomplete="off">
                        </span>
                    {% endif %}
                {% endfor %}
            </div>

            <form method="POST" id="game-form" style="display:none;">
                <input type="hidden" name="penalty_count" id="penalty_count" value="0">
                {% for t in targets %}
                    <input type="hidden" name="answers" value="{{ t }}">
                {% endfor %}
            </form>

            <button onclick="checkFinal()" class="btn btn-submit" id="submit-btn" disabled>ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”</button>
        </div>

        <script>
            const inputs = document.querySelectorAll('.quiz-input');
            const xpDisplay = document.getElementById('xp-val');
            const submitBtn = document.getElementById('submit-btn');
            
            let currentXP = {{ session['xp'] }};
            let penaltyCount = 0;

            inputs.forEach(input => {
                // [ë³€ê²½] input ì´ë²¤íŠ¸ ëŒ€ì‹  change(ì—”í„°, í¬ì»¤ìŠ¤ì•„ì›ƒ) ì´ë²¤íŠ¸ ì‚¬ìš©
                // ì…ë ¥ ì¤‘ì—ëŠ” ì±„ì í•˜ì§€ ì•ŠìŒ
                input.addEventListener('change', function() {
                    validateInput(this);
                    checkAllFilled();
                });

                // ì—”í„°í‚¤ ëˆ„ë¥´ë©´ í¬ì»¤ìŠ¤ í•´ì œí•˜ì—¬ change ì´ë²¤íŠ¸ ë°œìƒ ìœ ë„ & ë‹¤ìŒ ì¹¸ ì´ë™
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur(); // ê²€ì¦ íŠ¸ë¦¬ê±°
                        focusNext(this);
                    }
                });
            });

            function validateInput(input) {
                const val = input.value.trim();
                const ans = input.getAttribute('data-answer');
                const wrapper = input.parentElement; // word-group

                // ì´ë¯¸ ì •ë‹µì²˜ë¦¬ ëœ ê²ƒì€ íŒ¨ìŠ¤
                if (input.classList.contains('correct')) return;

                // 1. ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸°í™” (ê²€ì¦ ì•ˆí•¨)
                if (val === '') {
                    input.classList.remove('error');
                    wrapper.classList.remove('show-hint');
                    return;
                }

                // 2. ì •ë‹µ ì²´í¬
                if (val === ans) {
                    // ì •ë‹µ ë¡œì§
                    input.classList.remove('error');
                    wrapper.classList.remove('show-hint');
                    input.classList.add('correct');
                    input.readOnly = true; // ìˆ˜ì • ë¶ˆê°€
                    
                    animateXPChange(5, true); // +5 XP (ì‹œê°ì )
                } 
                else {
                    // ì˜¤ë‹µ ë¡œì§
                    input.classList.add('error');
                    wrapper.classList.add('show-hint'); // ì •ë‹µ ë§í’ì„  í‘œì‹œ
                    
                    animateXPChange(5, false); // -5 XP (ì‹œê°ì )
                    penaltyCount++; // ì„œë²„ ê¸°ë¡ìš© í˜ë„í‹° ì¦ê°€
                    document.getElementById('penalty_count').value = penaltyCount;
                }
            }

            // XP ì¦ê°€/ê°ì†Œ ì• ë‹ˆë©”ì´ì…˜ ë° ê°’ ë³€ê²½
            function animateXPChange(amount, isGain) {
                // ë°ì´í„° ì—…ë°ì´íŠ¸
                if (isGain) currentXP += amount;
                else currentXP -= amount;
                xpDisplay.innerText = currentXP;

                // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
                const anim = document.createElement('span');
                anim.className = 'xp-anim ' + (isGain ? 'xp-plus' : 'xp-minus');
                anim.innerText = isGain ? `+${amount} XP` : `-${amount} XP`;
                
                // ìœ„ì¹˜ ì¡ê¸° (XP ë°” ê·¼ì²˜)
                const rect = xpDisplay.getBoundingClientRect();
                anim.style.left = (rect.left + 20) + 'px';
                anim.style.top = (rect.top - 20) + 'px';
                
                document.body.appendChild(anim);
                setTimeout(() => anim.remove(), 800);
            }

            function checkAllFilled() {
                // ëª¨ë“  ì¹¸ì´ 'correct' ìƒíƒœì—¬ì•¼ ì™„ë£Œ ê°€ëŠ¥
                const allCorrect = Array.from(inputs).every(i => i.classList.contains('correct'));
                
                if (allCorrect) {
                    submitBtn.innerText = "ğŸ‰ í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ë³´ìƒ ë°›ê¸°";
                    submitBtn.disabled = false;
                    submitBtn.style.background = "#2ecc71";
                } else {
                    submitBtn.disabled = true;
                    submitBtn.innerText = "ëª¨ë‘ ì •ë‹µì„ ë§ì¶°ì£¼ì„¸ìš”";
                    submitBtn.style.background = "#4a90e2";
                }
            }

            function checkFinal() {
                document.getElementById('game-form').submit();
            }

            function focusNext(current) {
                const arr = Array.from(inputs);
                const idx = arr.indexOf(current);
                if (idx < arr.length - 1) {
                    // ë‹¤ìŒ ì¹¸ ì¤‘ ì•„ì§ ì •ë‹µì´ ì•„ë‹Œ ê³³ìœ¼ë¡œ ì´ë™
                    for (let i = idx + 1; i < arr.length; i++) {
                        if (!arr[i].readOnly) {
                            arr[i].focus();
                            break;
                        }
                    }
                }
            }
        </script>
        {% endif %}
    </div>
</body>
</html>
