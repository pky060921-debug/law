<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜ì „ í”Œë ˆì´</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #1a1a1a; color: #fff; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; background: #2a2a2a; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        /* ìƒë‹¨ UI */
        header { display: flex; justify-content: space-between; border-bottom: 2px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
        .xp-bar { font-size: 1.2rem; color: #4a90e2; font-weight: bold; }
        .xp-minus { color: #ff6b6b; animation: floatUp 0.5s ease-out; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: #fff; transition: 0.2s; }
        .btn-submit { background: #4a90e2; width: 100%; margin-top: 20px; font-size: 1.1rem; padding: 15px; }
        .btn-submit:hover { background: #357abd; }
        .btn-back { background: #555; }

        /* ê²Œì„ ë³´ë“œ (í…ìŠ¤íŠ¸ ì˜ì—­) */
        #game-board { line-height: 2.8; font-size: 1.15rem; text-align: left; word-break: keep-all; }
        
        /* ë‹¨ì–´ ê·¸ë£¹ (ì…ë ¥ì°½ + ì¡°ì‚¬) */
        .word-group { display: inline-block; white-space: nowrap; margin-right: 5px; }
        .particle { color: #aaa; font-weight: normal; }
        .prefix { color: #aaa; margin-right: 2px; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (ì—„ê²© ëª¨ë“œ) */
        input.quiz-input {
            background: #333; border: none; border-bottom: 2px solid #555;
            color: #fff; text-align: center; font-size: 1.1rem; padding: 2px 5px;
            border-radius: 3px; outline: none; font-family: inherit;
            transition: all 0.2s;
        }
        input.quiz-input:focus { border-bottom-color: #4a90e2; background: #3a3a3a; }
        
        /* ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ */
        input.correct { border-bottom-color: #2ecc71; background: #1e3a29; color: #2ecc71; font-weight: bold; pointer-events: none; }
        input.error { border-bottom-color: #ff6b6b; background: #3a1e1e; color: #ff6b6b; animation: shake 0.3s; }

        /* í¸ì§‘ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .edit-word { cursor: pointer; padding: 2px 4px; border-radius: 4px; border: 1px solid transparent; }
        .edit-word:hover { background: #444; border-color: #666; }
        .edit-word.selected { background: #d63031; color: white; border-color: #ff7675; }
        .edit-word.selected::before { content: '{'; color: #ffcc00; }
        .edit-word.selected::after { content: '}'; color: #ffcc00; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="/dungeon" class="btn btn-back">ğŸ”™ ë‚˜ê°€ê¸°</a>
            <div class="xp-bar">EXP: <span id="xp-val">{{ session['xp'] }}</span></div>
        </header>

        {% if edit_mode %}
        <div>
            <h2 style="color: #ffd700;">âœï¸ ë¹ˆì¹¸ ë§Œë“¤ê¸°</h2>
            <p style="color:#ccc; font-size:0.9rem;">í´ë¦­í•˜ì—¬ ë¹ˆì¹¸ìœ¼ë¡œ ë§Œë“¤ í•µì‹¬ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ì¡°ì‚¬ëŠ” ìë™ìœ¼ë¡œ ë¶„ë¦¬ë©ë‹ˆë‹¤)</p>
            
            <div id="edit-board" style="background:#222; padding:20px; border-radius:10px; min-height:100px; text-align:left; line-height:2.5;"></div>

            <form method="POST" id="edit-form">
                <input type="hidden" name="edited_content" id="edited_content">
                <button type="button" class="btn btn-submit" onclick="submitEdit()">ì„¤ì • ì™„ë£Œ (ê²Œì„ ì‹œì‘)</button>
            </form>
        </div>

        <script>
            const rawContent = `{{ raw_content | safe }}`;
            const editBoard = document.getElementById('edit-board');
            let tokenData = [];

            // 1. í…ìŠ¤íŠ¸ ë¶„ë¦¬ ë¡œì§ (ì¡°ì‚¬/ë¶€í˜¸ ë–¼ì–´ë‚´ê¸°)
            function parseText(text) {
                // ì¤„ë°”ê¿ˆ ë³´ì¡´ì„ ìœ„í•´ ë¬¸ë‹¨ìœ¼ë¡œ ë‚˜ëˆ”
                const paragraphs = text.split('\n');
                let html = '';
                let globalIdx = 0;

                paragraphs.forEach(para => {
                    if (!para.trim()) return;
                    html += '<div style="margin-bottom:10px;">';
                    const words = para.split(/\s+/);
                    
                    words.forEach(word => {
                        // ì •ê·œì‹: (ì ‘ë‘ì–´)(í•µì‹¬ë‹¨ì–´)(ì ‘ë¯¸ì–´/ë¶€í˜¸)
                        const match = word.match(/^([(\[\"\'\.]*)(.+?)([)\]\"\'\,\.\?]*)$/);
                        let prefix = match ? match[1] : "";
                        let core = match ? match[2] : word;
                        let suffix = match ? match[3] : "";

                        // ì¡°ì‚¬ ë¶„ë¦¬ (ê¸´ ê²ƒë¶€í„°)
                        const particles = ['ìœ¼ë¡œ', 'ì—ì„œ', 'ë¶€í„°', 'ê¹Œì§€', 'ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì˜', 'ì™€', 'ê³¼', 'ë¡œ', 'ë„', 'ë§Œ'];
                        for (let p of particles) {
                            if (core.endsWith(p) && core.length > p.length) {
                                suffix = p + suffix;
                                core = core.substring(0, core.length - p.length);
                                break;
                            }
                        }

                        // ë°ì´í„° ì €ì¥ (ë‚˜ì¤‘ì— ë³µì›ìš©)
                        tokenData.push({ prefix, core, suffix, selected: false });
                        
                        // HTML ìƒì„±
                        html += `<span class="word-group">`;
                        if(prefix) html += `<span class="prefix">${prefix}</span>`;
                        html += `<span class="edit-word" onclick="toggleWord(${globalIdx}, this)">${core}</span>`;
                        if(suffix) html += `<span class="particle">${suffix}</span>`;
                        html += `</span> `;
                        globalIdx++;
                    });
                    html += '</div>';
                });
                editBoard.innerHTML = html;
            }

            function toggleWord(idx, el) {
                tokenData[idx].selected = !tokenData[idx].selected;
                el.classList.toggle('selected');
            }

            function submitEdit() {
                // ì„ íƒëœ ë‹¨ì–´ì— {} ì”Œì›Œì„œ í…ìŠ¤íŠ¸ ì¬ì¡°ë¦½
                let finalStr = "";
                let pIdx = 0; // ì¤„ë°”ê¿ˆ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì›ë³¸ ì°¸ì¡°ê°€ í•„ìš”í•˜ì§€ë§Œ, ì—¬ê¸°ì„  ê³µë°±ìœ¼ë¡œ ë‹¨ìˆœ ì—°ê²°
                
                // ì¤„ë°”ê¿ˆ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ê¸° ì–´ë ¤ìš°ë¯€ë¡œ, tokenData ìˆœì„œëŒ€ë¡œ ì¬ì¡°ë¦½í•˜ë˜ ì¤„ë°”ê¿ˆì€ ì†Œì‹¤ë  ìˆ˜ ìˆìŒ.
                // í•˜ì§€ë§Œ app.py ë¡œì§ìƒ í•œ í€˜ìŠ¤íŠ¸ëŠ” í•œ ë¬¸ë‹¨(ì¡°í•­)ì´ë¯€ë¡œ ê³µë°± ì—°ê²°ë„ ë¬´ë°©í•¨.
                // ë” ì •í™•íˆ í•˜ë ¤ë©´ rawContentì˜ ì¤„ë°”ê¿ˆì„ ì¶”ì í•´ì•¼ í•¨. ì—¬ê¸°ì„  ë‹¨ìˆœí™”.
                
                finalStr = tokenData.map(t => {
                    let w = t.core;
                    if(t.selected) w = `{${w}}`;
                    return `${t.prefix}${w}${t.suffix}`;
                }).join(' ');

                document.getElementById('edited_content').value = finalStr;
                document.getElementById('edit-form').submit();
            }

            // ì´ˆê¸° ì‹¤í–‰
            parseText(rawContent);
        </script>

        {% else %}
        <div>
            <div id="game-board">
                {% for part in parts %}
                    {% if part.type == 'text' %}
                        <span>{{ part.val }}</span>
                    {% else %}
                        <input type="text" class="quiz-input" 
                               data-answer="{{ targets[part.id] }}"
                               style="width: {{ targets[part.id]|length * 16 + 10 }}px;"
                               autocomplete="off">
                    {% endif %}
                {% endfor %}
            </div>

            <form method="POST" id="game-form" style="display:none;">
                <input type="hidden" name="penalty_count" id="penalty_count" value="0">
                {% for t in targets %}
                    <input type="hidden" name="answers" value="{{ t }}">
                {% endfor %}
            </form>

            <button onclick="checkFinal()" class="btn btn-submit" id="submit-btn" disabled>ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”</button>
        </div>

        <script>
            const inputs = document.querySelectorAll('.quiz-input');
            const xpDisplay = document.getElementById('xp-val');
            const submitBtn = document.getElementById('submit-btn');
            let currentXP = {{ session['xp'] }};
            let penaltyCount = 0;

            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateInput(this);
                    checkAllFilled();
                });
            });

            function validateInput(input) {
                const val = input.value;
                const ans = input.dataAnswer || input.getAttribute('data-answer');
                
                // ì´ˆê¸°í™”
                input.classList.remove('correct', 'error');

                // 1. ì •ë‹µ ì²´í¬
                if (val === ans) {
                    input.classList.add('correct');
                    // ë‹¤ìŒ ì¹¸ìœ¼ë¡œ ìë™ ì´ë™ (ì„ íƒì‚¬í•­)
                    // focusNext(input);
                    return;
                }

                // 2. ì—„ê²©í•œ ì˜¤ë‹µ ì²´í¬ (ë„ì–´ì“°ê¸°, ê¸¸ì´ ì´ˆê³¼, ì˜¤íƒ€)
                let isError = false;
                if (val.includes(' ')) isError = true; // ê³µë°± ê¸ˆì§€
                if (val.length > ans.length) isError = true; // ê¸¸ì´ ì´ˆê³¼
                if (val.length > 0 && !ans.startsWith(val)) isError = true; // íƒ€ì´í•‘ ì¤‘ ì˜¤íƒ€

                if (isError) {
                    input.classList.add('error');
                    triggerPenalty();
                    // í‹€ë¦° ê¸€ì ì§€ìš°ê¸° (ì˜µì…˜: ì‚¬ìš©ìê°€ ì§ì ‘ ì§€ìš°ê²Œ í• ì§€, ìë™ ì‚­ì œí• ì§€)
                    // input.value = val.slice(0, -1); 
                }
            }

            function triggerPenalty() {
                // ì‹œê°ì  íš¨ê³¼
                const minus = document.createElement('span');
                minus.className = 'xp-minus';
                minus.innerText = '-2 XP';
                minus.style.position = 'absolute';
                minus.style.left = (xpDisplay.getBoundingClientRect().left + 20) + 'px';
                minus.style.top = (xpDisplay.getBoundingClientRect().top - 20) + 'px';
                document.body.appendChild(minus);
                
                setTimeout(() => minus.remove(), 500);

                // ë°ì´í„° ì²˜ë¦¬
                currentXP -= 2; // ì‹œê°ì  ê°ì†Œ
                penaltyCount++; // ì„œë²„ ì „ì†¡ìš© ì¹´ìš´íŠ¸
                xpDisplay.innerText = currentXP;
                document.getElementById('penalty_count').value = penaltyCount;
            }

            function checkAllFilled() {
                const allCorrect = Array.from(inputs).every(i => i.classList.contains('correct'));
                const allFilled = Array.from(inputs).every(i => i.value.length > 0);
                
                if (allCorrect) {
                    submitBtn.innerText = "ğŸ‰ í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ë³´ìƒ ë°›ê¸°";
                    submitBtn.disabled = false;
                    submitBtn.style.background = "#2ecc71";
                    // ìë™ ì œì¶œ í•˜ë ¤ë©´: document.getElementById('game-form').submit();
                } else {
                    submitBtn.disabled = true;
                    submitBtn.innerText = "ëª¨ë‘ ì •í™•íˆ ì±„ì›Œì£¼ì„¸ìš”";
                    submitBtn.style.background = "#4a90e2";
                }
            }

            function checkFinal() {
                // í¼ ì œì¶œ
                document.getElementById('game-form').submit();
            }

            function focusNext(current) {
                const idx = Array.from(inputs).indexOf(current);
                if (idx < inputs.length - 1) inputs[idx + 1].focus();
            }
        </script>
        {% endif %}
    </div>
</body>
</html>
