{% extends "layout.html" %}
{% block content %}
<style>
    .play-box { 
        background:#34495e; padding:20px; border-radius:10px; line-height: 1.6; font-size: 1.05rem; 
        text-align: justify; color: #ecf0f1;
    }
    
    .input-blank { 
        background:#2c3e50; border:none; border-bottom:1px solid #aaa; color:#f1c40f; 
        text-align:center; font-family:'Noto Sans KR'; width:80px; font-size: 1rem; padding: 0 5px; margin: 0 2px;
    }
    
    .input-full { 
        width:100%; height:100px; background:#222; color:white; padding:10px; 
        border:1px solid #555; font-size:1.1rem; line-height: 1.5; font-family:'Noto Sans KR'; margin-top: 10px;
    }
    
    .correct { color:#2ecc71; border-color:#2ecc71; font-weight:bold; }
    .error { color:#e74c3c; border-color:#e74c3c; animation: shake 0.3s; }
    
    @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-2px);} 75%{transform:translateX(2px);} }
</style>

<div style="text-align:center; margin-bottom:15px;">
    <span style="background:#f39c12; color:black; padding:3px 8px; border-radius:4px; font-weight:bold; font-size:0.85rem;">
        {% if mode == 'register_mnemonic' %}âœ¨ ì•½ì–´ ìƒì„± ì‘ì „
        {% elif mode == 'acquire' %}ğŸ“¥ íšë“ ì‘ì „
        {% elif mode == 'review' %}ë³µìŠµ ì‘ì „ (Lv.{{ level }})
        {% else %}âš¡ ì•½ì–´ ì‘ì „{% endif %}
    </span>
    <h3 style="margin-top:10px; margin-bottom:5px;">{{ title }}</h3>
</div>

<div class="play-box" id="game-area">
    {% if mode == 'register_mnemonic' %}
        <p style="color:#f1c40f; font-weight:bold;">ğŸ‰ ë ˆë²¨ 5 ë‹¬ì„±! ì´ì œ ë‚˜ë§Œì˜ ì•½ì–´(ë‘ë¬¸ì)ë¥¼ ë§Œë“œì„¸ìš”.</p>
        <p style="font-size:0.9rem; color:#bdc3c7;">ë³¸ë¬¸ì„ ë³´ê³  ì™¸ìš°ê¸° ì‰¬ìš´ ë‘ë¬¸ìë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì˜ˆë‹¨ì¹˜ì¬)</p>
        
        <div style="background:#2c3e50; padding:10px; margin-bottom:15px; border-radius:5px; font-size:0.9rem;">
            {{ parts[0].val | safe }} </div>

        <form method="POST" id="mnemonic-form">
            <input type="text" name="user_mnemonic" class="input-full" style="height:50px; text-align:center;" placeholder="ì•½ì–´ ì…ë ¥ (ì˜ˆ: ì˜ˆë‹¨ì¹˜ì¬)" required autocomplete="off">
            <button type="submit" style="width:100%; margin-top:20px; padding:12px; background:#e67e22; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1.1rem; font-weight:bold;">
                ì•½ì–´ ì €ì¥í•˜ê³  ì¡¸ì—…í•˜ê¸° ğŸ“
            </button>
        </form>

    {% else %}
        {% for p in parts %}
            {% if p.type == 'text' %}
                {{ p.val | safe }}
            
            {% elif p.type == 'input' %}
                <input type="text" class="input-blank" data-ans="{{ targets[p.id] }}" autocomplete="off">
            
            {% elif p.type == 'input_abbrev' %}
                <p style="color:#bdc3c7; font-size:0.9rem; margin-bottom:5px;">ì €ì¥í•œ ì•½ì–´(ë‘ë¬¸ì)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                <input type="text" id="abbrev-input" class="input-full" style="height:50px; text-align:center;" 
                       placeholder="ì•½ì–´ ì…ë ¥" data-ans="{{ p.mnemonic_ans }}" autocomplete="off">
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

{% if mode == 'abbrev' %}
<div id="phase-2-area" style="display:none; margin-top:20px;">
    <div class="play-box" style="border: 2px solid #2ecc71;">
        <p style="color:#2ecc71; font-weight:bold; margin:0;">ğŸ‰ ì•½ì–´ ì¼ì¹˜! ì´ì œ ì „ì²´ ë¬¸ì¥ì„ ì±„ìš°ì„¸ìš”.</p>
        <textarea id="full-input" class="input-full" placeholder="ì „ì²´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    </div>
</div>
{% endif %}


{% if mode != 'register_mnemonic' %}
    <div id="hint-text" style="display:none; margin-top:15px; padding:10px; background:rgba(0,0,0,0.3); border-radius:5px;">
        <div style="color:#e74c3c; font-weight:bold; font-size:0.9rem;">ì •ë‹µ:</div>
        <div style="color:#ecf0f1; white-space:pre-wrap; font-size:0.95rem;">
            {% if mode == 'abbrev' %}
                ì•½ì–´: <span id="hint-mnemonic"></span><br>
            {% endif %}
            {{ targets[0] }}
        </div>
    </div>

    <button id="check-btn" onclick="checkAnswer()" style="width:100%; margin-top:20px; padding:12px; background:#3498db; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1.1rem; font-weight:bold;">
        ì œì¶œí•˜ê¸°
    </button>
    <form method="POST" id="win-form" style="display:none;"></form>
{% endif %}

<script>
    const mode = '{{ mode }}';
    const targets = {{ targets | tojson }};
    let phase = 1;

    function checkAnswer() {
        // [ì•½ì–´ í…ŒìŠ¤íŠ¸ ëª¨ë“œ]
        if (mode === 'abbrev') {
            if (phase === 1) {
                // 1ë‹¨ê³„: ì•½ì–´ ê²€ì‚¬
                const inputElem = document.getElementById('abbrev-input');
                const userVal = inputElem.value.trim();
                const ansVal = inputElem.dataset.ans.trim(); // DBì— ì €ì¥ëœ ì•½ì–´

                if (userVal === ansVal) {
                    alert("ì•½ì–´ ì •ë‹µ! 2ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.");
                    document.getElementById('game-area').style.display = 'none';
                    document.getElementById('phase-2-area').style.display = 'block';
                    phase = 2;
                    document.getElementById('check-btn').innerText = "ìµœì¢… ì œì¶œ";
                } else {
                    alert("ì•½ì–´ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. (ë‚´ê°€ ì €ì¥í•œ ê²ƒ: " + ansVal + ")");
                }
            } else {
                // 2ë‹¨ê³„: ì „ì²´ ë¬¸ì¥ ê²€ì‚¬
                const inputFull = document.getElementById('full-input').value.replace(/\s+/g, '');
                const targetFull = targets[0].replace(/\s+/g, '');
                
                if (inputFull === targetFull) {
                    alert("ì™„ë²½í•©ë‹ˆë‹¤! ë§ˆìŠ¤í„°!");
                    document.getElementById('win-form').submit();
                } else {
                    alert("ë‚´ìš©ì´ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                    document.getElementById('hint-mnemonic').innerText = document.getElementById('abbrev-input').dataset.ans;
                    document.getElementById('hint-text').style.display = 'block';
                }
            }
        } 
        // [ì¼ë°˜/ë³µìŠµ ëª¨ë“œ]
        else {
            const inputs = document.querySelectorAll('.input-blank');
            let allOk = true;
            inputs.forEach(i => {
                if (i.value.trim() !== i.dataset.ans) {
                    i.classList.add('error');
                    allOk = false;
                } else {
                    i.classList.remove('error');
                    i.classList.add('correct');
                }
            });
            if (allOk) {
                alert("ì •ë‹µì…ë‹ˆë‹¤!");
                document.getElementById('win-form').submit();
            }
        }
    }
</script>
{% endblock %}
