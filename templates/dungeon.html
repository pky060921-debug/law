{% extends "layout.html" %}

{% block content %}
<style>
    /* [UI ê¹¨ì§ ë°©ì§€ í•µì‹¬] */
    * { box-sizing: border-box; }

    /* [íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜] */
    .upload-box {
        border: 2px dashed #5e4b3c;
        background: rgba(0,0,0,0.2);
        padding: 20px;
        border-radius: 10px;
        margin-top: 50px;
        text-align: center;
        width: 100%;
        overflow: hidden; /* ë„˜ì¹¨ ë°©ì§€ */
    }
    .upload-input {
        background: #222;
        border: 1px solid #444;
        color: #ccc;
        padding: 10px;
        border-radius: 5px;
        margin: 5px;
        width: 90%;
        max-width: 300px;
    }
    .btn-upload {
        background: #2c1e12;
        color: #d4af37;
        border: 1px solid #d4af37;
        padding: 10px 20px;
        cursor: pointer;
        font-family: 'Cinzel Decorative';
        margin-top: 10px;
    }
    .btn-upload:hover { background: #d4af37; color: #000; }

    /* [í€˜ìŠ¤íŠ¸ ê·¸ë£¹ ë²„íŠ¼] */
    .quest-group-btn {
        width: 100%;
        text-align: left;
        background: linear-gradient(to right, #1a0f2e, #2c1e12);
        color: #d4af37;
        padding: 20px;
        margin-top: 15px;
        border: 1px solid #5e4b3c;
        border-radius: 8px;
        font-family: 'Cinzel Decorative';
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .quest-group-btn:hover {
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        border-color: #d4af37;
    }

    /* [ì„¸ë¶€ ì±•í„° ëª©ë¡] */
    .chapter-list {
        display: none;
        background: rgba(0,0,0,0.5);
        border: 1px solid #444;
        border-top: none;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 0 0 8px 8px;
        width: 100%;
    }

    .chapter-item {
        display: block;
        width: 100%;
        text-align: left;
        background: transparent;
        color: #aaa;
        border: none;
        padding: 12px;
        border-bottom: 1px solid #333;
        cursor: pointer;
        transition: 0.2s;
        font-family: 'Spectral';
        font-size: 1rem;
    }
    .chapter-item:hover {
        color: #fff;
        background: rgba(212, 175, 55, 0.1);
        padding-left: 20px;
    }
</style>

<h1>âš”ï¸ ì§€ì‹ì˜ ì„œê³  (ë˜ì „)</h1>
<p style="text-align:center; color:#888;">í›ˆë ¨í•  ë²•ë ¹ì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.</p>

<div id="quest-container"></div>

<div class="upload-box">
    <h3 style="margin-top:0;">ğŸ“œ ì‹ ê·œ ë²•ë ¹ ë“±ë¡</h3>
    <p style="font-size: 0.9rem; color: #888;">
        í…ìŠ¤íŠ¸ íŒŒì¼ì˜ ë‚´ìš©ì„ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.<br>
        (ì˜ˆ: 'ì œ1ì¡°(ëª©ì )...' -> 'ì œ1ì¡°(ëª©ì )' ì±•í„° ìƒì„±)
    </p>
    <form method="POST" enctype="multipart/form-data">
        <input type="text" class="upload-input" name="new_q_name" placeholder="ë²•ë ¹ ì œëª© (ì˜ˆ: ë¯¼ë²•)" required>
        <input type="file" class="upload-input" name="new_q_file" accept=".txt" required>
        <button type="submit" class="btn-upload">ë“±ë¡í•˜ê¸°</button>
    </form>
</div>

<script>
    const allQuests = {{ quests | tojson }};
    const container = document.getElementById('quest-container');
    
    const groups = {};
    
    allQuests.forEach(q => {
        // DBì— ì €ì¥ëœ ì´ë¦„: "ë¯¼ë²•-ì œ1ì¡°(ëª©ì )"
        let parts = q.quest_name.split('-');
        let title = parts[0]; 
        let subTitle = q.quest_name; 
        
        if (parts.length > 1) {
            // '-' ë’¤ì— ìˆëŠ” ì „ì²´ë¥¼ ê°€ì ¸ì˜´ (ì˜ˆ: ì œ1ì¡°(ëª©ì ))
            subTitle = q.quest_name.substring(title.length + 1);
        }

        if (!groups[title]) {
            groups[title] = [];
        }
        groups[title].push({
            fullName: q.quest_name, 
            displayName: subTitle   
        });
    });

    if (Object.keys(groups).length === 0) {
        container.innerHTML = "<div style='text-align:center; padding:30px; color:#666;'>ë“±ë¡ëœ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    }

    for (const [title, chapters] of Object.entries(groups)) {
        const groupBtn = document.createElement('div');
        groupBtn.className = 'quest-group-btn';
        groupBtn.innerHTML = `<span>ğŸ“‚ ${title}</span> <span style="font-size:0.8em; color:#888;">${chapters.length}ê°œ ì¡°í•­</span>`;
        
        const listDiv = document.createElement('div');
        listDiv.className = 'chapter-list';

        chapters.forEach(chap => {
            const form = document.createElement('form');
            form.method = 'POST';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'quest_select';
            input.value = chap.fullName;
            
            const btn = document.createElement('button');
            btn.className = 'chapter-item';
            btn.type = 'submit';
            
            // [ìˆ˜ì •] ì´ë¯¸ ì´ë¦„ì´ 'ì œ1ì¡°' í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ì¶œë ¥, ìˆ«ìë§Œ ìˆìœ¼ë©´ 'ì œ N ì¡°' ë¶™ì„
            let viewName = chap.displayName;
            if (/^\d+$/.test(viewName)) {
                viewName = `ì œ ${viewName} ì¡°`;
            }
            btn.innerText = `ğŸ“„ ${viewName}`;

            form.appendChild(input);
            form.appendChild(btn);
            listDiv.appendChild(form);
        });

        groupBtn.onclick = () => {
            const isVisible = listDiv.style.display === 'block';
            document.querySelectorAll('.chapter-list').forEach(el => el.style.display = 'none');
            listDiv.style.display = isVisible ? 'none' : 'block';
        };

        container.appendChild(groupBtn);
        container.appendChild(listDiv);
    }
</script>
{% endblock %}
