{% extends "layout.html" %}

{% block content %}
<style>
    * { box-sizing: border-box; }

    .upload-box {
        border: 2px dashed #5e4b3c;
        background: rgba(0,0,0,0.2);
        padding: 20px;
        border-radius: 10px;
        margin-top: 50px;
        text-align: center;
        width: 100%;
        overflow: hidden; 
    }
    .upload-input {
        background: #222; border: 1px solid #444; color: #ccc; padding: 10px;
        border-radius: 5px; margin: 5px; width: 90%; max-width: 300px;
    }
    .btn-upload {
        background: #2c1e12; color: #d4af37; border: 1px solid #d4af37;
        padding: 10px 20px; cursor: pointer; font-family: 'Cinzel Decorative'; margin-top: 10px;
    }
    .btn-upload:hover { background: #d4af37; color: #000; }

    .quest-group-btn {
        width: 100%; text-align: left;
        background: linear-gradient(to right, #1a0f2e, #2c1e12);
        color: #d4af37; padding: 15px; margin-top: 15px;
        border: 1px solid #5e4b3c; border-radius: 8px;
        font-family: 'Cinzel Decorative'; font-size: 1.2rem;
        cursor: pointer; transition: 0.3s;
        display: flex; justify-content: space-between; align-items: center;
    }
    .quest-group-btn:hover { box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); border-color: #d4af37; }

    /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-delete {
        background: #c0392b; color: white; border: none;
        padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; margin-left: 10px;
        cursor: pointer; z-index: 10;
    }
    .btn-delete:hover { background: #e74c3c; }

    .chapter-list {
        display: none; background: rgba(0,0,0,0.5); border: 1px solid #444;
        border-top: none; padding: 10px; margin-bottom: 20px; border-radius: 0 0 8px 8px; width: 100%;
    }

    .chapter-item {
        display: block; width: 100%; text-align: left; background: transparent;
        color: #aaa; border: none; padding: 12px; border-bottom: 1px solid #333;
        cursor: pointer; transition: 0.2s; font-family: 'Spectral'; font-size: 1rem;
    }
    .chapter-item:hover { color: #fff; background: rgba(212, 175, 55, 0.1); padding-left: 20px; }
</style>

<h1>âš”ï¸ ì‘ì „ì§€ì—­ (ë˜ì „)</h1>
<p style="text-align:center; color:#888;">í›ˆë ¨í•  ë²•ë ¹ì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.</p>

<div id="quest-container"></div>

<div class="upload-box">
    <h3 style="margin-top:0;">ğŸ“œ ì‹ ê·œ ë²•ë ¹ ë“±ë¡</h3>
    <p style="font-size: 0.9rem; color: #888;">
        í…ìŠ¤íŠ¸ íŒŒì¼ì˜ ë‚´ìš©ì„ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.<br>
        (ì˜ˆ: 'ì œ1ì¡°(ëª©ì )...' -> 'ì œ1ì¡°(ëª©ì )' ì±•í„° ìƒì„±)
    </p>
    <form method="POST" enctype="multipart/form-data">
        <input type="text" class="upload-input" name="new_q_name" placeholder="ë²•ë ¹ ì œëª© (ì˜ˆ: ë¯¼ë²•)" required>
        <input type="file" class="upload-input" name="new_q_file" accept=".txt" required>
        <button type="submit" class="btn-upload">ë“±ë¡í•˜ê¸°</button>
    </form>
</div>

<script>
    const allQuests = {{ quests | tojson }};
    const container = document.getElementById('quest-container');
    const groups = {};
    
    allQuests.forEach(q => {
        let parts = q.quest_name.split('-');
        let title = parts[0]; 
        let subTitle = q.quest_name; 
        if (parts.length > 1) {
            subTitle = q.quest_name.substring(title.length + 1);
        }
        if (!groups[title]) { groups[title] = []; }
        groups[title].push({ fullName: q.quest_name, displayName: subTitle });
    });

    if (Object.keys(groups).length === 0) {
        container.innerHTML = "<div style='text-align:center; padding:30px; color:#666;'>ë“±ë¡ëœ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    }

    for (const [title, chapters] of Object.entries(groups)) {
        // ê·¸ë£¹ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
        const groupBtn = document.createElement('div');
        groupBtn.className = 'quest-group-btn';
        
        // ì œëª© í…ìŠ¤íŠ¸
        const titleSpan = document.createElement('span');
        titleSpan.innerHTML = `ğŸ“‚ ${title} <span style="font-size:0.7em; color:#888;">(${chapters.length}ê°œ)</span>`;
        
        // ì‚­ì œ í¼ ë° ë²„íŠ¼ (ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€)
        const deleteForm = document.createElement('form');
        deleteForm.method = 'POST';
        deleteForm.style.margin = '0';
        deleteForm.onsubmit = (e) => {
            if(!confirm(`ì •ë§ë¡œ '${title}' ë²•ë ¹ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                e.preventDefault();
            }
        };
        
        const deleteInput = document.createElement('input');
        deleteInput.type = 'hidden';
        deleteInput.name = 'delete_group';
        deleteInput.value = title;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-delete';
        deleteBtn.innerHTML = 'ğŸ—‘ï¸ ì‚­ì œ';
        deleteBtn.onclick = (e) => { e.stopPropagation(); }; // ë²„íŠ¼ ëˆŒë €ì„ë•Œ ëª©ë¡ ì•ˆ ì—´ë¦¬ê²Œ

        deleteForm.appendChild(deleteInput);
        deleteForm.appendChild(deleteBtn);
        
        groupBtn.appendChild(titleSpan);
        groupBtn.appendChild(deleteForm);
        
        const listDiv = document.createElement('div');
        listDiv.className = 'chapter-list';

        chapters.forEach(chap => {
            const form = document.createElement('form');
            form.method = 'POST';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'quest_select';
            input.value = chap.fullName;
            
            const btn = document.createElement('button');
            btn.className = 'chapter-item';
            btn.type = 'submit';
            
            let viewName = chap.displayName;
            if (/^\d+$/.test(viewName)) { viewName = `ì œ ${viewName} ì¡°`; }
            btn.innerText = `ğŸ“„ ${viewName}`;

            form.appendChild(input);
            form.appendChild(btn);
            listDiv.appendChild(form);
        });

        groupBtn.onclick = () => {
            const isVisible = listDiv.style.display === 'block';
            document.querySelectorAll('.chapter-list').forEach(el => el.style.display = 'none');
            listDiv.style.display = isVisible ? 'none' : 'block';
        };

        container.appendChild(groupBtn);
        container.appendChild(listDiv);
    }
</script>
{% endblock %}
