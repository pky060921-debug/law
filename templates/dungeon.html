{% extends "layout.html" %}

{% block content %}
<style>
    * { box-sizing: border-box; }

    /* ì—…ë¡œë“œ ë°•ìŠ¤ */
    .upload-box {
        border: 2px dashed #5e4b3c;
        background: rgba(0,0,0,0.2);
        padding: 20px;
        border-radius: 10px;
        margin-top: 40px;
        text-align: center;
        width: 100%;
    }
    .upload-input {
        background: #222; border: 1px solid #444; color: #ccc; 
        padding: 12px; border-radius: 5px; margin: 5px; 
        width: 60%; /* PC */
    }
    .btn-upload {
        background: #2c1e12; color: #d4af37; border: 1px solid #d4af37;
        padding: 12px 20px; cursor: pointer; font-family: 'Cinzel Decorative';
    }

    /* í€˜ìŠ¤íŠ¸ ëª©ë¡ */
    .quest-group-btn {
        width: 100%; 
        background: linear-gradient(to right, #1a0f2e, #2c1e12);
        color: #d4af37; padding: 15px; margin-top: 15px;
        border: 1px solid #5e4b3c; border-radius: 8px;
        font-family: 'Cinzel Decorative'; font-size: 1.2rem;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        flex-wrap: wrap; /* ë‚´ìš© ë§ìœ¼ë©´ ì¤„ë°”ê¿ˆ */
    }
    .quest-group-btn:active { transform: scale(0.98); }

    .btn-delete {
        background: #c0392b; color: white; border: none;
        padding: 8px 12px; border-radius: 5px; font-size: 0.9rem; margin-left: 10px;
        cursor: pointer;
    }

    .chapter-list {
        display: none; background: rgba(0,0,0,0.3); border: 1px solid #444; border-top: none;
        padding: 5px; margin-bottom: 20px; border-radius: 0 0 8px 8px;
    }
    .chapter-item {
        width: 100%; text-align: left; background: transparent; color: #aaa;
        border: none; padding: 15px; border-bottom: 1px solid #333; cursor: pointer;
        font-size: 1rem;
    }
    .chapter-item:active { background: rgba(255,255,255,0.1); }

    /* ğŸ“± ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
        .upload-input { width: 100%; margin-bottom: 10px; }
        .btn-upload { width: 100%; }
        .quest-group-btn { font-size: 1rem; padding: 12px; }
    }
</style>

<h1>âš”ï¸ ì‘ì „ì§€ì—­ (ë˜ì „)</h1>
<p style="text-align:center; color:#888;">í›ˆë ¨í•  ë²•ë ¹ì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.</p>

<div id="quest-container"></div>

<div class="upload-box">
    <h3 style="margin-top:0;">ğŸ“œ ì‹ ê·œ ë²•ë ¹ ë“±ë¡</h3>
    <form method="POST" enctype="multipart/form-data" style="display:flex; flex-direction:column; align-items:center;">
        <input type="text" class="upload-input" name="new_q_name" placeholder="ë²•ë ¹ ì œëª© (ì˜ˆ: ë¯¼ë²•)" required>
        <input type="file" class="upload-input" name="new_q_file" accept=".txt" required>
        <button type="submit" class="btn-upload">ë“±ë¡í•˜ê¸°</button>
    </form>
</div>

<script>
    const allQuests = {{ quests | tojson }};
    const container = document.getElementById('quest-container');
    const groups = {};
    
    allQuests.forEach(q => {
        let parts = q.quest_name.split('-');
        let title = parts[0]; 
        let subTitle = q.quest_name; 
        if (parts.length > 1) { subTitle = q.quest_name.substring(title.length + 1); }
        if (!groups[title]) { groups[title] = []; }
        groups[title].push({ fullName: q.quest_name, displayName: subTitle });
    });

    if (Object.keys(groups).length === 0) {
        container.innerHTML = "<div style='text-align:center; padding:30px; color:#666;'>ë“±ë¡ëœ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    }

    for (const [title, chapters] of Object.entries(groups)) {
        const groupBtn = document.createElement('div');
        groupBtn.className = 'quest-group-btn';
        
        const titleSpan = document.createElement('span');
        titleSpan.innerHTML = `ğŸ“‚ ${title} <span style="font-size:0.8em; color:#888;">(${chapters.length})</span>`;
        
        const deleteForm = document.createElement('form');
        deleteForm.method = 'POST';
        deleteForm.style.margin = '0';
        deleteForm.onsubmit = (e) => {
            if(!confirm(`'${title}' ë²•ë ¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³µêµ¬ ë¶ˆê°€)`)) e.preventDefault();
        };
        const deleteInput = document.createElement('input');
        deleteInput.type = 'hidden'; deleteInput.name = 'delete_group'; deleteInput.value = title;
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-delete'; deleteBtn.innerHTML = 'ğŸ—‘ï¸';
        deleteBtn.onclick = (e) => { e.stopPropagation(); };

        deleteForm.appendChild(deleteInput);
        deleteForm.appendChild(deleteBtn);
        
        groupBtn.appendChild(titleSpan);
        groupBtn.appendChild(deleteForm);
        
        const listDiv = document.createElement('div');
        listDiv.className = 'chapter-list';

        chapters.forEach(chap => {
            const form = document.createElement('form');
            form.method = 'POST';
            
            const input = document.createElement('input');
            input.type = 'hidden'; input.name = 'quest_select'; input.value = chap.fullName;
            const btn = document.createElement('button');
            btn.className = 'chapter-item'; btn.type = 'submit';
            
            let viewName = chap.displayName;
            if (/^\d+$/.test(viewName)) { viewName = `ì œ ${viewName} ì¡°`; }
            btn.innerText = `ğŸ“„ ${viewName}`;

            form.appendChild(input); form.appendChild(btn); listDiv.appendChild(form);
        });

        groupBtn.onclick = () => {
            const isVisible = listDiv.style.display === 'block';
            document.querySelectorAll('.chapter-list').forEach(el => el.style.display = 'none');
            listDiv.style.display = isVisible ? 'none' : 'block';
        };

        container.appendChild(groupBtn);
        container.appendChild(listDiv);
    }
</script>
{% endblock %}
