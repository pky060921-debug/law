{% extends "layout.html" %}

{% block content %}
<style>
    /* [íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ ìŠ¤íƒ€ì¼] */
    .upload-box {
        border: 2px dashed #5e4b3c;
        background: rgba(0,0,0,0.2);
        padding: 20px;
        border-radius: 10px;
        margin-top: 50px;
        text-align: center;
    }
    .upload-input {
        background: #222;
        border: 1px solid #444;
        color: #ccc;
        padding: 10px;
        border-radius: 5px;
        margin: 5px;
    }
    .btn-upload {
        background: #2c1e12;
        color: #d4af37;
        border: 1px solid #d4af37;
        padding: 10px 20px;
        cursor: pointer;
        font-family: 'Cinzel Decorative';
    }
    .btn-upload:hover { background: #d4af37; color: #000; }

    /* [í€˜ìŠ¤íŠ¸ ê·¸ë£¹ ë²„íŠ¼ ìŠ¤íƒ€ì¼] */
    .quest-group-btn {
        width: 100%;
        text-align: left;
        background: linear-gradient(to right, #1a0f2e, #2c1e12);
        color: #d4af37;
        padding: 20px;
        margin-top: 15px;
        border: 1px solid #5e4b3c;
        border-radius: 8px;
        font-family: 'Cinzel Decorative';
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .quest-group-btn:hover {
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        border-color: #d4af37;
    }

    /* [ì„¸ë¶€ ì±•í„° ëª©ë¡ (ìˆ¨ê¹€ ìƒíƒœ)] */
    .chapter-list {
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        background: rgba(0,0,0,0.5);
        border: 1px solid #444;
        border-top: none;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 0 0 8px 8px;
    }

    /* [ì„¸ë¶€ ì±•í„° ë²„íŠ¼] */
    .chapter-item {
        display: block;
        width: 100%;
        text-align: left;
        background: transparent;
        color: #aaa;
        border: none;
        padding: 12px;
        border-bottom: 1px solid #333;
        cursor: pointer;
        transition: 0.2s;
        font-family: 'Spectral';
        font-size: 1rem;
    }
    .chapter-item:hover {
        color: #fff;
        background: rgba(212, 175, 55, 0.1);
        padding-left: 20px; /* ì‚´ì§ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ íš¨ê³¼ */
    }
</style>

<h1>âš”ï¸ ì§€ì‹ì˜ ì„œê³  (ë˜ì „)</h1>
<p style="text-align:center; color:#888;">í›ˆë ¨í•  ë²•ë ¹ì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.</p>

<div id="quest-container">
    </div>

<div class="upload-box">
    <h3 style="margin-top:0;">ğŸ“œ ì‹ ê·œ ë²•ë ¹ ë“±ë¡</h3>
    <p style="font-size: 0.9rem; color: #888;">
        í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì—”í„° ë‹¨ìœ„ë¡œ ì±•í„°ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.<br>
        ì œëª© ì˜ˆ: 'ë¯¼ë²•' ì…ë ¥ ì‹œ -> ë¯¼ë²•-1, ë¯¼ë²•-2... ë¡œ ìƒì„±
    </p>
    <form method="POST" enctype="multipart/form-data">
        <input type="text" class="upload-input" name="new_q_name" placeholder="ë²•ë ¹ ì œëª© (ì˜ˆ: ë¯¼ë²•)" required>
        <input type="file" class="upload-input" name="new_q_file" accept=".txt" required>
        <button type="submit" class="btn-upload">ë“±ë¡í•˜ê¸°</button>
    </form>
</div>

<script>
    // Flaskì—ì„œ ë„˜ê²¨ì¤€ í€˜ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ JSë¡œ ê°€ì ¸ì˜´
    const allQuests = {{ quests | tojson }};
    const container = document.getElementById('quest-container');
    
    // 1. ë°ì´í„°ë¥¼ ì œëª©ë³„ë¡œ ê·¸ë£¹í™” (ì˜ˆ: 'ë¯¼ë²•-1', 'ë¯¼ë²•-2' -> 'ë¯¼ë²•' ê·¸ë£¹)
    const groups = {};
    
    allQuests.forEach(q => {
        // ì´ë¦„ì´ "ì œëª©-ë²ˆí˜¸" í˜•ì‹ì´ ì•„ë‹ˆë”ë¼ë„ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ ë¡œì§ êµ¬ì„±
        let parts = q.quest_name.split('-');
        let title = parts[0]; // "ë¯¼ë²•"
        let subTitle = q.quest_name; // ê¸°ë³¸ê°’
        
        // "-"ê°€ ìˆë‹¤ë©´ ë’·ë¶€ë¶„ì„ ì„¸ë¶€ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
        if (parts.length > 1) {
            subTitle = q.quest_name.substring(title.length + 1); // "1", "ì œ1ì¡°" ë“±
        }

        if (!groups[title]) {
            groups[title] = [];
        }
        groups[title].push({
            fullName: q.quest_name, // ì„œë²„ì— ë³´ë‚¼ ì‹¤ì œ ì´ë¦„
            displayName: subTitle   // í™”ë©´ì— ë³´ì—¬ì¤„ ì´ë¦„
        });
    });

    // 2. HTML ìƒì„±
    if (Object.keys(groups).length === 0) {
        container.innerHTML = "<div style='text-align:center; padding:30px; color:#666;'>ë“±ë¡ëœ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    }

    for (const [title, chapters] of Object.entries(groups)) {
        // (1) ê·¸ë£¹ ë²„íŠ¼ ìƒì„± (ì˜ˆ: ë¯¼ë²•)
        const groupBtn = document.createElement('div');
        groupBtn.className = 'quest-group-btn';
        groupBtn.innerHTML = `<span>ğŸ“‚ ${title}</span> <span style="font-size:0.8em; color:#888;">${chapters.length}ê°œ ì¡°í•­</span>`;
        
        // (2) ì„¸ë¶€ ëª©ë¡ ì»¨í…Œì´ë„ˆ ìƒì„±
        const listDiv = document.createElement('div');
        listDiv.className = 'chapter-list';

        // (3) ê° ì±•í„° ë²„íŠ¼ ìƒì„±
        chapters.forEach(chap => {
            // ë²„íŠ¼ì„ ê°ì‹¸ëŠ” í¼ ìƒì„± (POST ì „ì†¡ì„ ìœ„í•´)
            const form = document.createElement('form');
            form.method = 'POST';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'quest_select';
            input.value = chap.fullName;
            
            const btn = document.createElement('button');
            btn.className = 'chapter-item';
            btn.type = 'submit';
            
            // ì±•í„° ì´ë¦„ ê¾¸ë¯¸ê¸° (ìˆ«ìë§Œ ìˆìœ¼ë©´ 'ì œNì¡°' ë¶™ì´ê¸°, ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ)
            let viewName = chap.displayName;
            if (!isNaN(viewName)) {
                viewName = `ì œ ${viewName} ì¡°`;
            }
            btn.innerText = `ğŸ“„ ${viewName}`;

            form.appendChild(input);
            form.appendChild(btn);
            listDiv.appendChild(form);
        });

        // (4) í´ë¦­ ì´ë²¤íŠ¸ (ì—´ê³  ë‹«ê¸°)
        groupBtn.onclick = () => {
            const isVisible = listDiv.style.display === 'block';
            // ê¸°ì¡´ì— ì—´ë¦° ë‹¤ë¥¸ ë©”ë‰´ ë‹«ê¸° (ì„ íƒì‚¬í•­ - ì›ì¹˜ ì•Šìœ¼ë©´ ì´ ì¤„ ì‚­ì œ)
            document.querySelectorAll('.chapter-list').forEach(el => el.style.display = 'none');
            
            listDiv.style.display = isVisible ? 'none' : 'block';
        };

        container.appendChild(groupBtn);
        container.appendChild(listDiv);
    }
</script>
{% endblock %}
