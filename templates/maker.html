{% extends "layout.html" %}

{% block content %}
<style>
    .maker-box {
        background: #34495e; padding: 20px; border-radius: 10px; border: 1px solid #3498db;
        margin-top: 15px;
    }
    textarea {
        width: 100%; height: 250px; background: #2c3e50; color: #ecf0f1;
        border: 1px solid #7f8c8d; border-radius: 5px; padding: 10px; 
        font-size: 1rem; line-height: 1.5; resize: vertical;
        font-family: 'Noto Sans KR'; margin-bottom: 15px;
    }
    
    /* [ìˆ˜ì •ë¨] í† í° ìŠ¤íƒ€ì¼: ëª¨ë“  ê¸€ì í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½ */
    .token {
        cursor: pointer; 
        padding: 0 1px;
        border-radius: 2px; 
        display: inline-block; 
        margin: 0;
        border-bottom: 2px solid transparent; 
        transition: 0.1s;
        color: #ecf0f1; /* ê¸°ë³¸ ê¸€ììƒ‰ */
    }
    .token:hover { background: rgba(52, 152, 219, 0.3); border-bottom-color: #3498db; }
    
    /* ì„ íƒëœ ë¹ˆì¹¸ */
    .token.selected { 
        background: #c0392b; color: white; font-weight: 500; border-radius: 2px; border-bottom-color: #c0392b;
    }

    /* ë„ì–´ì“°ê¸° í† í° */
    .space-token {
        display: inline-block;
        width: 4px;
    }
    
    .btn-action {
        background: #3498db; color: white; border: none; padding: 8px 20px; 
        border-radius: 20px; font-weight: bold; font-size: 0.95rem; cursor: pointer; margin: 5px;
    }
    .btn-save { background: #2ecc71; padding: 12px 30px; font-size: 1.1rem; }
    .btn-reset { background: #e74c3c; }
    .btn-switch { background: #e67e22; }
</style>

<h1>âœï¸ ì¹´ë“œ ë‚´ìš© ìˆ˜ì •</h1>
<p style="color:#aaa; text-align:center; margin-bottom: 10px; font-size: 0.9rem;">
    '{{ title }}'ì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  ë¹ˆì¹¸ì„ ì§€ì •í•˜ì„¸ìš”.
</p>

<div class="maker-box">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span style="font-size:0.9rem; color:#bdc3c7;">* ê¸€ìë¥¼ í´ë¦­í•˜ë©´ ë¹ˆì¹¸ì´ ë©ë‹ˆë‹¤.</span>
        <div>
            <button type="button" class="btn-action btn-switch" onclick="switchMode()">ğŸ“ ê¸€ìˆ˜ì • ëª¨ë“œ</button>
        </div>
    </div>

    <div id="text-mode" style="display:none;">
        <textarea id="raw_text">{{ raw_text }}</textarea>
        <div style="text-align:center;">
             <button type="button" class="btn-action btn-save" onclick="switchMode()">ë¹ˆì¹¸ ëš«ìœ¼ëŸ¬ ê°€ê¸° â¡ï¸</button>
        </div>
    </div>

    <div id="token-mode">
        <div id="editor-area" style="line-height: 1.8; font-size: 1.1rem; min-height:200px; text-align: justify; word-break: break-all; letter-spacing: -0.03em; background:#2c3e50; padding:15px; border-radius:5px;"></div>
        
        <div style="text-align:center; margin-top:20px;">
            <button type="button" class="btn-action btn-reset" onclick="resetAll()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
            <button type="button" class="btn-action btn-save" onclick="saveCard()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
        
        <form method="POST" id="save-form">
            <input type="hidden" name="title" value="{{ title }}">
            <input type="hidden" name="final_content" id="final_content">
        </form>
    </div>
</div>

<script>
    const textArea = document.getElementById('raw_text');
    const textMode = document.getElementById('text-mode');
    const tokenMode = document.getElementById('token-mode');
    const editorArea = document.getElementById('editor-area');
    let tokens = [];

    // ì¡°ì‚¬ ë¦¬ìŠ¤íŠ¸ (ë¶„ë¦¬ìš©)
    const particles = [
        'ìœ¼ë¡œì„œ', 'ìœ¼ë¡œì¨', 'ì—ì„œë„', 'ì—ì„œëŠ”', 'ì—ê²ŒëŠ”', 'ê¹Œì§€ë„', 'ë¶€í„°ëŠ”', 'ì—ê²Œì„œ', 'ìœ¼ë¡œëŠ”', 'í•˜ë¼ê³ ', 'í•œë‹¤ê³ ', 'ì´ë¼ëŠ”', 'ì´ë¼ê³ ', 'ì´ë‚˜ë§ˆ', 'ì´ë¼ë„', 'ì•¼ë§ë¡œ', 'ê»˜ì„œëŠ”', 
        'ì—ì„œëŠ”', 'ì—ê²ŒëŠ”', 'ìœ¼ë¡œëŠ”', 'ìœ¼ë¡œë¶€í„°', 'ì—ì„œë¶€í„°',
        'ë¼ê³ ', 'ìœ¼ë¡œ', 'ì—ì„œ', 'ë¶€í„°', 'ê¹Œì§€', 'ì´ë‹¤', 'ì´ë‚˜', 'ì´ë©°', 'ì´ê³ ', 'ì´ë¼', 'ì´ìš”', 'í•˜ëŸ¬', 'í•˜ì§€', 'í•˜ì—¬', 'í•˜ë˜', 'í•˜ê³ ', 'í•˜ë©´', 'í•˜ë‹ˆ', 'í•˜ë‹¤', 'ì—ëŠ”', 'ì—ê²Œ', 'í•œí…Œ', 'ë³´ë‹¤', 'ì²˜ëŸ¼', 'ë§Œí¼', 'ë§ˆë‹¤', 'ì¡°ì°¨', 'ë§ˆì €', 'ë¼ë„', 'ë‚˜ë§ˆ', 'ì´ë‘', 'ê»˜ì„œ', 'ê³¼ëŠ”', 'ì™€ëŠ”', 
        'ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì˜', 'ì™€', 'ê³¼', 'ë¡œ', 'ë„', 'ë§Œ', 'ê»˜', 'ë‘', 'ë©°', 'ê³ ', 'ë¼', 'ìš”', 'ì„œ', 'ì—¬'
    ];

    // ì´ˆê¸° ì‹¤í–‰
    initTokens(textArea.value);

    function switchMode() {
        if (textMode.style.display !== 'none') {
            textMode.style.display = 'none';
            tokenMode.style.display = 'block';
            initTokens(textArea.value);
        } else {
            tokenMode.style.display = 'none';
            textMode.style.display = 'block';
            textArea.value = constructText();
        }
    }

    function initTokens(text) {
        // [ìˆ˜ì •ë¨] ìª¼ê°œëŠ” ê¸°ì¤€: {ë¹ˆì¹¸}, ê³µë°±, íŠ¹ìˆ˜ë¬¸ì
        const parts = text.split(/(\{.+?\}|\s+|[.,Â·â€¢;:\(\)\[\]"'\?!~%])/);
        
        let html = '';
        tokens = [];
        let idx = 0;

        parts.forEach(part => {
            if (!part) return;
            
            // 1. ê³µë°±
            if (/^\s+$/.test(part)) {
                html += part.replace(/\n/g, '<br>').replace(/ /g, '<span class="space-token"> </span>');
                tokens.push({ text: part, type: 'space' });
            } 
            // 2. ì´ë¯¸ {ë¹ˆì¹¸}ì¸ ê²½ìš°
            else if (part.startsWith('{') && part.endsWith('}')) {
                const core = part.slice(1, -1);
                tokens.push({ text: core, type: 'word', selected: true });
                html += `<span class="token selected" id="t-${idx}" onclick="toggle(${idx})">${core}</span>`;
                idx++;
            }
            // 3. íŠ¹ìˆ˜ë¬¸ì (ì´ì œ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ word íƒ€ì…ìœ¼ë¡œ ì²˜ë¦¬í•˜ë˜ ë¶„ë¦¬ëŠ” ìœ ì§€)
            else if (/^[.,Â·â€¢;:\(\)\[\]"'\?!~%]$/.test(part)) {
                tokens.push({ text: part, type: 'word', selected: false });
                html += `<span class="token" id="t-${idx}" onclick="toggle(${idx})">${part}</span>`;
                idx++;
            }
            // 4. ì¼ë°˜ ë‹¨ì–´ (ì¡°ì‚¬ ë¶„ë¦¬)
            else {
                let noun = part;
                let particle = "";

                for (let p of particles) {
                    if (noun.endsWith(p) && noun.length > p.length) {
                        particle = p;
                        noun = noun.slice(0, -p.length);
                        break;
                    }
                }

                // ëª…ì‚¬ ë¶€ë¶„
                tokens.push({ text: noun, type: 'word', selected: false });
                html += `<span class="token" id="t-${idx}" onclick="toggle(${idx})">${noun}</span>`;
                idx++;

                // ì¡°ì‚¬ ë¶€ë¶„ (ì´ì œ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½!)
                if (particle) {
                    tokens.push({ text: particle, type: 'word', selected: false });
                    html += `<span class="token" id="t-${idx}" onclick="toggle(${idx})">${particle}</span>`;
                    idx++;
                }
            }
        });
        editorArea.innerHTML = html;
    }

    function toggle(idx) {
        const t = tokens[idx];
        if (t.type === 'space') return; // ê³µë°±ë§Œ í´ë¦­ ë°©ì§€
        
        // [ìˆ˜ì •ë¨] í† ê¸€ ë¡œì§ (On <-> Off)
        t.selected = !t.selected;
        
        const el = document.getElementById(`t-${idx}`);
        if (t.selected) el.classList.add('selected');
        else el.classList.remove('selected');
    }

    // [ì‹ ê·œ] ì „ì²´ ì´ˆê¸°í™” í•¨ìˆ˜
    function resetAll() {
        if(!confirm("ëª¨ë“  ë¹ˆì¹¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        tokens.forEach((t, i) => {
            if (t.selected) {
                t.selected = false;
                const el = document.getElementById(`t-${i}`);
                if(el) el.classList.remove('selected');
            }
        });
    }

    function constructText() {
        return tokens.map(t => {
            if (t.selected) return `{${t.text}}`;
            return t.text;
        }).join('');
    }

    function saveCard() {
        document.getElementById('final_content').value = constructText();
        document.getElementById('save-form').submit();
    }
</script>
{% endblock %}
