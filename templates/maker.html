{% extends "layout.html" %}

{% block content %}
<style>
    /* ì œì‘ê¸° ìŠ¤íƒ€ì¼ */
    .maker-box {
        background: #34495e; padding: 25px; border-radius: 15px; border: 2px solid #3498db;
    }
    textarea {
        width: 100%; height: 200px; background: #2c3e50; color: #ecf0f1;
        border: 1px solid #7f8c8d; border-radius: 5px; padding: 15px; font-size: 1.1rem; resize: vertical;
        font-family: 'Noto Sans KR';
    }
    .token {
        cursor: pointer; padding: 2px 5px; border-radius: 4px; display: inline-block; margin: 2px;
        border: 1px solid transparent; transition:0.2s;
    }
    .token:hover { background: rgba(52, 152, 219, 0.3); border-color: #3498db; }
    .token.selected { background: #e74c3c; color: white; font-weight: bold; border-color: #c0392b; }
    
    .btn-action {
        background: #3498db; color: white; border: none; padding: 12px 30px; 
        border-radius: 30px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 20px;
    }
</style>

<h1>âœï¸ ë¹ˆì¹¸ ì¹´ë“œ ì œì‘ê¸°</h1>

{% if step == 'input' %}
    <p style="text-align:center; color:#aaa;">ì›í•˜ëŠ” ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
    <div class="maker-box">
        <form method="POST">
            <input type="text" name="title" placeholder="ì¹´ë“œ ì œëª© (ì˜ˆ: ë¯¼ë²• ì œ1ì¡°)" required
                   style="width:100%; padding:10px; margin-bottom:15px; border-radius:5px; border:none;">
            <textarea name="raw_text" placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
            <div style="text-align:center;">
                <button type="submit" class="btn-action">ë‹¤ìŒ ë‹¨ê³„ë¡œ â¡ï¸</button>
            </div>
        </form>
    </div>

{% elif step == 'edit' %}
    <p style="text-align:center; color:#aaa;">ë¹ˆì¹¸ìœ¼ë¡œ ë§Œë“¤ ë‹¨ì–´ë¥¼ í´ë¦­í•˜ì„¸ìš”!</p>
    
    <div class="maker-box" id="editor-area" style="line-height: 2.0; font-size: 1.2rem;"></div>

    <form method="POST" id="save-form" style="text-align:center;">
        <input type="hidden" name="title" value="{{ title }}">
        <input type="hidden" name="final_content" id="final_content">
        <button type="button" class="btn-action" onclick="saveCard()" style="background:#2ecc71;">
            ì €ì¥í•˜ê¸° ğŸ’¾
        </button>
    </form>

    <script>
        const rawText = `{{ raw_text | safe }}`;
        const editor = document.getElementById('editor-area');
        let tokens = [];

        // í…ìŠ¤íŠ¸ë¥¼ ë‹¨ì–´ ë‹¨ìœ„ë¡œ ìª¼ê°œê¸°
        function initEditor() {
            // ì¤„ë°”ê¿ˆ ë³´ì¡´ì„ ìœ„í•´ ë¬¸ë‹¨ìœ¼ë¡œ ë‚˜ëˆ”
            const paragraphs = rawText.split('\n');
            let html = '';
            
            paragraphs.forEach(para => {
                if(!para.trim()) return;
                html += '<div style="margin-bottom:10px;">';
                const words = para.split(' ');
                words.forEach(word => {
                    // íŠ¹ìˆ˜ë¬¸ì ë¶„ë¦¬ (ê°„ë‹¨í•˜ê²Œ)
                    tokens.push({ text: word, selected: false });
                    const idx = tokens.length - 1;
                    html += `<span class="token" onclick="toggle(${idx}, this)">${word}</span> `;
                });
                html += '</div>';
            });
            editor.innerHTML = html;
        }

        function toggle(idx, el) {
            tokens[idx].selected = !tokens[idx].selected;
            if(tokens[idx].selected) el.classList.add('selected');
            else el.classList.remove('selected');
        }

        function saveCard() {
            let result = "";
            let currentLine = "";
            // ë‹¤ì‹œ í…ìŠ¤íŠ¸ë¡œ í•©ì¹˜ê¸° (ì„ íƒëœê±´ {}ë¡œ ê°ìŒˆ)
            // ì£¼ì˜: ë‹¨ìˆœ ì˜ˆì‹œì´ë¯€ë¡œ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ê°€ ì™„ë²½í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ.
            // ì—¬ê¸°ì„œëŠ” HTML êµ¬ì¡° ëŒ€ì‹  tokens ë°°ì—´ì„ ìˆœíšŒí•˜ë©° ì¬êµ¬ì„±
            
            // ì‹¤ì œë¡œëŠ” ì›ë³¸ í…ìŠ¤íŠ¸ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ëŠ”ê²Œ ì–´ë ¤ìš°ë¯€ë¡œ, 
            // ìœ„ì—ì„œ ìƒì„±í•œ í† í° ìˆœì„œëŒ€ë¡œ ê³µë°±ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
            let constructed = tokens.map(t => {
                return t.selected ? `{${t.text}}` : t.text;
            }).join(' ');
            
            document.getElementById('final_content').value = constructed;
            document.getElementById('save-form').submit();
        }

        initEditor();
    </script>
{% endif %}

{% endblock %}
