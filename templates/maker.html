{% extends "layout.html" %}

{% block content %}
<style>
    .maker-box {
        background: #34495e; padding: 20px; border-radius: 10px; border: 1px solid #3498db;
        margin-top: 15px;
    }
    textarea {
        width: 100%; height: 250px; background: #2c3e50; color: #ecf0f1;
        border: 1px solid #7f8c8d; border-radius: 5px; padding: 10px; 
        font-size: 1rem; line-height: 1.5; resize: vertical;
        font-family: 'Noto Sans KR'; margin-bottom: 15px;
    }
    
    /* [ìˆ˜ì •ë¨] í† í° ìŠ¤íƒ€ì¼: ê°„ê²© ìµœì†Œí™” */
    .token {
        cursor: pointer; 
        padding: 0 1px; /* íŒ¨ë”© ìµœì†Œí™” */
        border-radius: 2px; 
        display: inline-block; 
        margin: 0; /* ë§ˆì§„ ì œê±° (ë”± ë¶™ê²Œ) */
        border-bottom: 2px solid transparent; 
        transition: 0.1s;
    }
    .token:hover { background: rgba(52, 152, 219, 0.3); border-bottom-color: #3498db; }
    
    /* ì„ íƒëœ ë¹ˆì¹¸ */
    .token.selected { 
        background: #c0392b; color: white; font-weight: 500; border-radius: 2px;
    }

    /* [ìˆ˜ì •ë¨] ì¡°ì‚¬ ë° íŠ¹ìˆ˜ë¬¸ì: ê°„ê²© ì—†ì• ê¸° */
    .static-part {
        display: inline-block;
        color: #bdc3c7;
        margin: 0; /* ë§ˆì§„ 0 */
        font-size: 0.95em;
    }

    /* [ìˆ˜ì •ë¨] ë„ì–´ì“°ê¸° ë„ˆë¹„ ëŒ€í­ ì¶•ì†Œ */
    .space-token {
        display: inline-block;
        width: 3px; /* ë„ì–´ì“°ê¸° ë„ˆë¹„ë¥¼ 3pxë¡œ ì¢í˜ */
    }
    
    .btn-action {
        background: #3498db; color: white; border: none; padding: 10px 25px; 
        border-radius: 20px; font-weight: bold; font-size: 1rem; cursor: pointer;
    }
    .btn-save { background: #2ecc71; }
    .btn-switch { background: #e67e22; margin-bottom: 10px; font-size: 0.9rem; padding: 8px 15px;}
</style>

<h1>âœï¸ ì¹´ë“œ ë‚´ìš© ìˆ˜ì •</h1>
<p style="color:#aaa; text-align:center; margin-bottom: 10px; font-size: 0.9rem;">
    '{{ title }}'ì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  ë¹ˆì¹¸ì„ ì§€ì •í•˜ì„¸ìš”.
</p>

<div class="maker-box">
    <div style="text-align:right;">
        <button type="button" class="btn-action btn-switch" onclick="switchMode()">ğŸ”„ ëª¨ë“œ ì „í™˜ (ê¸€ìˆ˜ì • â†” ë¹ˆì¹¸)</button>
    </div>

    <div id="text-mode">
        <textarea id="raw_text">{{ raw_text }}</textarea>
        <p style="font-size:0.85rem; color:#bdc3c7;">* í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì™„ë£Œ í›„ 'ëª¨ë“œ ì „í™˜'ì„ ëˆŒëŸ¬ ë¹ˆì¹¸ì„ ë§Œë“œì„¸ìš”.</p>
    </div>

    <div id="token-mode" style="display:none;">
        <div id="editor-area" style="line-height: 1.8; font-size: 1.1rem; min-height:150px; text-align: justify; word-break: break-all; letter-spacing: -0.03em;"></div>
        
        <p style="font-size:0.85rem; color:#bdc3c7; margin-top:10px;">* ë‹¨ì–´ë¥¼ í´ë¦­í•˜ì—¬ ë¹¨ê°„ìƒ‰(ë¹ˆì¹¸)ìœ¼ë¡œ ë§Œë“œì„¸ìš”. íŠ¹ìˆ˜ë¬¸ìì™€ ì¡°ì‚¬ëŠ” ìë™ ë¶„ë¦¬ë©ë‹ˆë‹¤.</p>
        
        <form method="POST" id="save-form" style="text-align:center; margin-top:20px;">
            <input type="hidden" name="title" value="{{ title }}">
            <input type="hidden" name="final_content" id="final_content">
            <button type="button" class="btn-action btn-save" onclick="saveCard()">
                ì €ì¥í•˜ê¸° ğŸ’¾
            </button>
        </form>
    </div>
</div>

<script>
    const textArea = document.getElementById('raw_text');
    const textMode = document.getElementById('text-mode');
    const tokenMode = document.getElementById('token-mode');
    const editorArea = document.getElementById('editor-area');
    let tokens = [];

    // [ì¡°ì‚¬ ë¦¬ìŠ¤íŠ¸] ê¸¸ì´ ê¸´ ìˆœì„œëŒ€ë¡œ ì •ë ¬
    const particles = [
        'ìœ¼ë¡œì„œ', 'ìœ¼ë¡œì¨', 'ì—ì„œë„', 'ì—ì„œëŠ”', 'ì—ê²ŒëŠ”', 'ê¹Œì§€ë„', 'ë¶€í„°ëŠ”', 'ì—ê²Œì„œ', 'ìœ¼ë¡œëŠ”', 'í•˜ë¼ê³ ', 'í•œë‹¤ê³ ', 'ì´ë¼ëŠ”', 'ì´ë¼ê³ ', 'ì´ë‚˜ë§ˆ', 'ì´ë¼ë„', 'ì•¼ë§ë¡œ', 'ê»˜ì„œëŠ”', 
        'ì—ì„œëŠ”', 'ì—ê²ŒëŠ”', 'ìœ¼ë¡œëŠ”', 'ìœ¼ë¡œë¶€í„°', 'ì—ì„œë¶€í„°',
        'ë¼ê³ ', 'ìœ¼ë¡œ', 'ì—ì„œ', 'ë¶€í„°', 'ê¹Œì§€', 'ì´ë‹¤', 'ì´ë‚˜', 'ì´ë©°', 'ì´ê³ ', 'ì´ë¼', 'ì´ìš”', 'í•˜ëŸ¬', 'í•˜ì§€', 'í•˜ì—¬', 'í•˜ë˜', 'í•˜ê³ ', 'í•˜ë©´', 'í•˜ë‹ˆ', 'í•˜ë‹¤', 'ì—ëŠ”', 'ì—ê²Œ', 'í•œí…Œ', 'ë³´ë‹¤', 'ì²˜ëŸ¼', 'ë§Œí¼', 'ë§ˆë‹¤', 'ì¡°ì°¨', 'ë§ˆì €', 'ë¼ë„', 'ë‚˜ë§ˆ', 'ì´ë‘', 'ê»˜ì„œ', 'ê³¼ëŠ”', 'ì™€ëŠ”', 
        'ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì˜', 'ì™€', 'ê³¼', 'ë¡œ', 'ë„', 'ë§Œ', 'ê»˜', 'ë‘', 'ë©°', 'ê³ ', 'ë¼', 'ìš”', 'ì„œ', 'ì—¬'
    ];

    function switchMode() {
        if (textMode.style.display !== 'none') {
            textMode.style.display = 'none';
            tokenMode.style.display = 'block';
            initTokens(textArea.value);
        } else {
            tokenMode.style.display = 'none';
            textMode.style.display = 'block';
            textArea.value = constructText();
        }
    }

    function initTokens(text) {
        // [ìˆ˜ì •ë¨] ì •ê·œì‹: {ë¹ˆì¹¸}, ê³µë°±, ê·¸ë¦¬ê³  ê°ì¢… íŠ¹ìˆ˜ë¬¸ì([ ], ., Â·, ,, ", ' ë“±)ë¥¼ ëª¨ë‘ ë¶„ë¦¬ìë¡œ ì¸ì‹
        const parts = text.split(/(\{.+?\}|\s+|[.,Â·â€¢;:\(\)\[\]"'\?!~%])/);
        
        let html = '';
        tokens = [];
        let idx = 0;

        parts.forEach(part => {
            if (!part) return;
            
            // 1. ê³µë°± ì²˜ë¦¬
            if (/^\s+$/.test(part)) {
                html += part.replace(/\n/g, '<br>').replace(/ /g, '<span class="space-token"> </span>');
                tokens.push({ text: part, type: 'space' });
            } 
            // 2. ì´ë¯¸ {ë¹ˆì¹¸}ìœ¼ë¡œ ì§€ì •ëœ ê²½ìš°
            else if (part.startsWith('{') && part.endsWith('}')) {
                const core = part.slice(1, -1);
                tokens.push({ text: core, type: 'word', selected: true });
                html += `<span class="token selected" id="t-${idx}" onclick="toggle(${idx})">${core}</span>`;
                idx++;
            }
            // 3. íŠ¹ìˆ˜ë¬¸ìì¸ ê²½ìš° (í´ë¦­ ë¶ˆê°€, static)
            else if (/^[.,Â·â€¢;:\(\)\[\]"'\?!~%]$/.test(part)) {
                tokens.push({ text: part, type: 'static' });
                html += `<span class="static-part">${part}</span>`;
            }
            // 4. ì¼ë°˜ ë‹¨ì–´ -> ì¡°ì‚¬ ë¶„ë¦¬ ì‹œë„
            else {
                let noun = part;
                let particle = "";

                // ì¡°ì‚¬ ì°¾ê¸°
                for (let p of particles) {
                    if (noun.endsWith(p) && noun.length > p.length) {
                        particle = p;
                        noun = noun.slice(0, -p.length);
                        break;
                    }
                }

                // ëª…ì‚¬ ë¶€ë¶„ (í´ë¦­ ê°€ëŠ¥)
                tokens.push({ text: noun, type: 'word', selected: false });
                html += `<span class="token" id="t-${idx}" onclick="toggle(${idx})">${noun}</span>`;
                idx++;

                // ì¡°ì‚¬ ë¶€ë¶„ (í´ë¦­ ë¶ˆê°€)
                if (particle) {
                    tokens.push({ text: particle, type: 'static' });
                    html += `<span class="static-part">${particle}</span>`;
                }
            }
        });
        editorArea.innerHTML = html;
    }

    function toggle(idx) {
        const t = tokens[idx];
        if (t.type !== 'word') return;
        t.selected = !t.selected;
        const el = document.getElementById(`t-${idx}`);
        if (t.selected) el.classList.add('selected');
        else el.classList.remove('selected');
    }

    function constructText() {
        return tokens.map(t => {
            if (t.type === 'word' && t.selected) return `{${t.text}}`;
            return t.text;
        }).join('');
    }

    function saveCard() {
        document.getElementById('final_content').value = constructText();
        document.getElementById('save-form').submit();
    }
</script>
{% endblock %}
