{% extends "layout.html" %}

{% block content %}
<style>
    .maker-box {
        background: #34495e; padding: 20px; border-radius: 10px; border: 1px solid #3498db;
        margin-top: 15px;
    }
    textarea {
        width: 100%; height: 250px; background: #2c3e50; color: #ecf0f1;
        border: 1px solid #7f8c8d; border-radius: 5px; padding: 10px; 
        font-size: 1rem; line-height: 1.5; resize: vertical;
        font-family: 'Noto Sans KR'; margin-bottom: 15px;
    }
    
    .token {
        cursor: pointer; padding: 0 1px; border-radius: 3px; display: inline-block; margin: 0;
        border-bottom: 2px solid transparent; transition: 0.1s; color: #ecf0f1; user-select: none;
    }
    .token:hover { background: rgba(52, 152, 219, 0.3); border-bottom-color: #3498db; }
    
    .token.selected { background: #c0392b; color: white; font-weight: 500; border-radius: 3px; border-bottom-color: #e74c3c; }
    .token.title-word { background: #2980b9; color: white; font-weight: bold; border-radius: 3px; border-bottom-color: #3498db; }
    .space-token { display: inline-block; width: 4px; white-space: pre; }
    
    .btn-action {
        background: #3498db; color: white; border: none; padding: 8px 15px; 
        border-radius: 20px; font-weight: bold; font-size: 0.9rem; cursor: pointer; margin: 5px;
    }
    .btn-save { background: #2ecc71; padding: 12px 30px; font-size: 1.1rem; }
    .btn-reset { background: #e74c3c; }
    .btn-mode { opacity: 0.6; }
    .btn-mode.active { opacity: 1; border: 2px solid white; transform: scale(1.05); }
    .btn-split { background: #8e44ad; }
</style>

<div style="text-align:center; margin-bottom:15px;">
    <h2 style="color:#f39c12; margin-bottom:5px;">
        <span style="font-size:0.8em; color:#bdc3c7;" id="disp-prefix"></span>
        <span id="disp-suffix"></span>
    </h2>
    <p style="color:#aaa; font-size:0.9rem;">'ì œëª© ì„¤ì •' ëª¨ë“œ ì‹œ ê·¸ë£¹ëª…ì€ ìœ ì§€ë˜ê³  ë’·ë¶€ë¶„ë§Œ ë³€ê²½ë©ë‹ˆë‹¤.</p>
</div>

<div style="text-align:right; margin-bottom:10px;">
    <form method="POST" style="display:inline;" onsubmit="return confirm('í˜„ì¬ ë‚´ìš©ì„ ë¬¸ë‹¨(ë¹ˆ ì¤„) ë‹¨ìœ„ë¡œ ìª¼ê°œì‹œê² ìŠµë‹ˆê¹Œ?');">
        <input type="hidden" name="title" value="{{ title }}">
        <button type="submit" name="split_action" value="split" class="btn-action btn-split">
            âœ‚ï¸ ë¬¸ë‹¨ë³„ ë‚˜ëˆ„ê¸°
        </button>
    </form>
</div>

<div class="maker-box">
    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
        <button type="button" class="btn-action btn-mode active" id="btn-blank" onclick="setMode('blank')" style="background:#c0392b;">ğŸŸ¥ ë¹ˆì¹¸ ëš«ê¸°</button>
        <button type="button" class="btn-action btn-mode" id="btn-title" onclick="setMode('title')" style="background:#2980b9;">ğŸ‘‘ ì œëª© ì„¤ì •</button>
        <button type="button" class="btn-action btn-switch" onclick="switchTextMode()" style="background:#e67e22;">ğŸ“ ê¸€ìˆ˜ì •</button>
    </div>

    <div id="text-mode" style="display:none;">
        <textarea id="raw_text">{{ raw_text }}</textarea>
        <div style="text-align:center;">
             <button type="button" class="btn-action btn-save" onclick="switchTextMode()">ì™„ë£Œí•˜ê³  í† í°í™” â¡ï¸</button>
        </div>
    </div>

    <div id="token-mode">
        <div id="editor-area" style="line-height: 1.8; font-size: 1.1rem; min-height:200px; text-align: justify; word-break: break-all; letter-spacing: -0.03em; background:#2c3e50; padding:15px; border-radius:5px;"></div>
        
        <div style="text-align:center; margin-top:20px;">
            <button type="button" class="btn-action btn-reset" onclick="resetAll()">ğŸ”„ ì´ˆê¸°í™”</button>
            <button type="button" class="btn-action btn-save" onclick="saveCard()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
        
        <form method="POST" id="save-form">
            <input type="hidden" name="old_title" value="{{ title }}">
            <input type="hidden" name="title" id="final_title" value="{{ title }}">
            <input type="hidden" name="final_content" id="final_content">
        </form>
    </div>
</div>

<script>
    const textArea = document.getElementById('raw_text');
    const textMode = document.getElementById('text-mode');
    const tokenMode = document.getElementById('token-mode');
    const editorArea = document.getElementById('editor-area');
    
    // [í•µì‹¬] ì›ë˜ ì œëª© ë¶„ì„
    const originalFullTitle = "{{ title }}";
    let groupPrefix = ""; // ê·¸ë£¹ëª… (ì˜ˆ: í˜•ë²•)
    let currentSuffix = originalFullTitle; // ë’·ë¶€ë¶„ (ì˜ˆ: ì œ1ì¡°)

    // '-'ê°€ ìˆìœ¼ë©´ ë¶„ë¦¬
    const lastDashIdx = originalFullTitle.lastIndexOf('-');
    if (lastDashIdx !== -1) {
        groupPrefix = originalFullTitle.substring(0, lastDashIdx + 1); // "í˜•ë²•-"
        currentSuffix = originalFullTitle.substring(lastDashIdx + 1);  // "ì œ1ì¡°"
    }

    // í™”ë©´ í‘œì‹œ ì´ˆê¸°í™”
    document.getElementById('disp-prefix').innerText = groupPrefix;
    document.getElementById('disp-suffix').innerText = currentSuffix;

    let tokens = [];
    let currentMode = 'blank'; 

    initTokens(textArea.value);

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('btn-blank').classList.toggle('active', mode === 'blank');
        document.getElementById('btn-title').classList.toggle('active', mode === 'title');
    }

    function switchTextMode() {
        if (textMode.style.display !== 'none') {
            textMode.style.display = 'none';
            tokenMode.style.display = 'block';
            initTokens(textArea.value);
        } else {
            tokenMode.style.display = 'none';
            textMode.style.display = 'block';
            textArea.value = constructText();
        }
    }

    function initTokens(text) {
        const parts = text.split(/(\{.+?\}|\s+|[^\wê°€-í£])/g);
        let html = '';
        tokens = [];
        let idx = 0;

        parts.forEach(part => {
            if (!part || part === '') return;
            
            if (/^\s+$/.test(part)) {
                html += part.replace(/\n/g, '<br>').replace(/ /g, '<span class="space-token"> </span>');
                tokens.push({ text: part, type: 'space', selected: false, isTitle: false });
                idx++;
            } 
            else if (part.startsWith('{') && part.endsWith('}')) {
                const core = part.slice(1, -1);
                tokens.push({ text: core, type: 'word', selected: true, isTitle: false });
                html += `<span class="token selected" id="t-${idx}" onclick="toggle(${idx})">${core}</span>`;
                idx++;
            }
            else if (/^[^\wê°€-í£]$/.test(part)) {
                tokens.push({ text: part, type: 'word', selected: false, isTitle: false });
                html += `<span class="token" id="t-${idx}" onclick="toggle(${idx})">${part}</span>`;
                idx++;
            }
            else {
                let noun = part; 
                tokens.push({ text: noun, type: 'word', selected: false, isTitle: false });
                html += `<span class="token" id="t-${idx}" onclick="toggle(${idx})">${noun}</span>`;
                idx++;
            }
        });
        editorArea.innerHTML = html;
    }

    function toggle(idx) {
        const t = tokens[idx];
        const el = document.getElementById(`t-${idx}`);
        if (t.type === 'space') return;

        if (currentMode === 'blank') {
            t.selected = !t.selected;
            if (t.selected) {
                el.classList.add('selected');
                t.isTitle = false; el.classList.remove('title-word');
            } else el.classList.remove('selected');
        } else {
            t.isTitle = !t.isTitle;
            if (t.isTitle) {
                el.classList.add('title-word');
                t.selected = false; el.classList.remove('selected');
            } else el.classList.remove('title-word');
            updateTitlePreview();
        }
    }

    // [í•µì‹¬] ì œëª© ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ê·¸ë£¹ëª… + ì„ íƒë‹¨ì–´)
    function updateTitlePreview() {
        const selectedWords = tokens.filter(t => t.isTitle).map(t => t.text).join('');
        
        // ì„ íƒí•œ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ë’·ë¶€ë¶„(Suffix)ìœ¼ë¡œ ì‚¬ìš©
        if (selectedWords.length > 0) {
            document.getElementById('disp-suffix').innerText = selectedWords;
            document.getElementById('final_title').value = groupPrefix + selectedWords;
        } else {
            // ì„ íƒí•œ ê²Œ ì—†ìœ¼ë©´ ì›ë˜ ì œëª© ìœ ì§€
            document.getElementById('disp-suffix').innerText = currentSuffix;
            document.getElementById('final_title').value = originalFullTitle;
        }
    }

    function resetAll() {
        if(!confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì œëª© ì„¤ì •ë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)")) return;
        tokens.forEach((t, i) => {
            t.selected = false;
            t.isTitle = false;
            const el = document.getElementById(`t-${i}`);
            if (el) { el.classList.remove('selected'); el.classList.remove('title-word'); }
        });
        updateTitlePreview();
    }

    function constructText() {
        return tokens.map(t => {
            if (t.type !== 'space' && t.selected) return `{${t.text}}`;
            return t.text;
        }).join('');
    }

    function saveCard() {
        document.getElementById('final_content').value = constructText();
        document.getElementById('save-form').submit();
    }
</script>
{% endblock %}
