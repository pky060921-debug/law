{% extends "layout.html" %}

{% block content %}
<style>
    .maker-box {
        background: #34495e; padding: 25px; border-radius: 15px; border: 2px solid #3498db;
        margin-top: 20px;
    }
    textarea {
        width: 100%; height: 200px; background: #2c3e50; color: #ecf0f1;
        border: 1px solid #7f8c8d; border-radius: 5px; padding: 15px; font-size: 1.1rem; resize: vertical;
        font-family: 'Noto Sans KR'; margin-bottom: 20px;
    }
    
    /* í† í° ìŠ¤íƒ€ì¼ */
    .token {
        cursor: pointer; padding: 2px 5px; border-radius: 4px; display: inline-block; margin: 2px;
        border: 1px solid transparent; transition:0.2s;
    }
    .token:hover { background: rgba(52, 152, 219, 0.3); border-color: #3498db; }
    .token.selected { background: #e74c3c; color: white; font-weight: bold; border-color: #c0392b; }
    
    .btn-action {
        background: #3498db; color: white; border: none; padding: 12px 30px; 
        border-radius: 30px; font-weight: bold; font-size: 1.1rem; cursor: pointer;
    }
    .btn-save { background: #2ecc71; }
    .btn-switch { background: #e67e22; margin-bottom: 10px; }
</style>

<h1>âœï¸ ì¹´ë“œ ë‚´ìš© ìˆ˜ì •</h1>
<p style="color:#aaa; text-align:center;">'{{ title }}'ì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  ë¹ˆì¹¸ì„ ì§€ì •í•˜ì„¸ìš”.</p>

<div class="maker-box">
    <div style="text-align:right;">
        <button type="button" class="btn-action btn-switch" onclick="switchMode()">ğŸ”„ ëª¨ë“œ ì „í™˜ (ê¸€ìˆ˜ì • â†” ë¹ˆì¹¸)</button>
    </div>

    <div id="text-mode">
        <textarea id="raw_text">{{ raw_text }}</textarea>
        <p style="font-size:0.9rem; color:#bdc3c7;">* í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì™„ë£Œ í›„ 'ëª¨ë“œ ì „í™˜'ì„ ëˆŒëŸ¬ ë¹ˆì¹¸ì„ ë§Œë“œì„¸ìš”.</p>
    </div>

    <div id="token-mode" style="display:none;">
        <div id="editor-area" style="line-height: 2.0; font-size: 1.2rem; min-height:150px;"></div>
        <p style="font-size:0.9rem; color:#bdc3c7; margin-top:15px;">* ë‹¨ì–´ë¥¼ í´ë¦­í•˜ì—¬ ë¹¨ê°„ìƒ‰(ë¹ˆì¹¸)ìœ¼ë¡œ ë§Œë“œì„¸ìš”.</p>
        
        <form method="POST" id="save-form" style="text-align:center; margin-top:20px;">
            <input type="hidden" name="title" value="{{ title }}">
            <input type="hidden" name="final_content" id="final_content">
            <button type="button" class="btn-action btn-save" onclick="saveCard()">
                ì €ì¥í•˜ê¸° ğŸ’¾
            </button>
        </form>
    </div>
</div>

<script>
    const textArea = document.getElementById('raw_text');
    const textMode = document.getElementById('text-mode');
    const tokenMode = document.getElementById('token-mode');
    const editorArea = document.getElementById('editor-area');
    let tokens = [];

    // ëª¨ë“œ ì „í™˜ í•¨ìˆ˜
    function switchMode() {
        if (textMode.style.display !== 'none') {
            // í…ìŠ¤íŠ¸ -> í† í° ëª¨ë“œë¡œ ì „í™˜
            textMode.style.display = 'none';
            tokenMode.style.display = 'block';
            initTokens(textArea.value);
        } else {
            // í† í° -> í…ìŠ¤íŠ¸ ëª¨ë“œë¡œ ë³µê·€ (ë¹ˆì¹¸ ì •ë³´ëŠ” {ê´„í˜¸}ë¡œ ë³€í™˜ë˜ì–´ í…ìŠ¤íŠ¸ë¡œ ë“¤ì–´ê°)
            tokenMode.style.display = 'none';
            textMode.style.display = 'block';
            textArea.value = constructText();
        }
    }

    // í…ìŠ¤íŠ¸ë¥¼ í† í°ìœ¼ë¡œ ë¶„í•´
    function initTokens(text) {
        // ê¸°ì¡´ {ì •ë‹µ} í˜•ì‹ì„ ê°ì§€í•˜ì—¬ selected ìƒíƒœë¡œ ë§Œë“¦
        // ì •ê·œì‹: {ë‚´ìš©} ë˜ëŠ” ì¼ë°˜ ë‹¨ì–´
        const parts = text.split(/(\{.+?\}|\s+)/); // ê´„í˜¸ ë©ì–´ë¦¬ í˜¹ì€ ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬
        
        let html = '';
        tokens = [];
        let idx = 0;

        parts.forEach(part => {
            if (!part) return;
            
            // ê³µë°±ì´ë‚˜ ì¤„ë°”ê¿ˆì€ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬
            if (/^\s+$/.test(part)) {
                html += part.replace(/\n/g, '<br>');
                tokens.push({ text: part, type: 'space' });
            } 
            // {ì •ë‹µ} í˜•ì‹ì¸ ê²½ìš°
            else if (part.startsWith('{') && part.endsWith('}')) {
                const core = part.slice(1, -1); // ê´„í˜¸ ì œê±°
                tokens.push({ text: core, type: 'word', selected: true });
                html += `<span class="token selected" id="t-${idx}" onclick="toggle(${idx})">${core}</span>`;
            }
            // ì¼ë°˜ ë‹¨ì–´ì¸ ê²½ìš°
            else {
                tokens.push({ text: part, type: 'word', selected: false });
                html += `<span class="token" id="t-${idx}" onclick="toggle(${idx})">${part}</span>`;
            }
            idx++;
        });
        editorArea.innerHTML = html;
    }

    function toggle(idx) {
        const t = tokens[idx];
        if (t.type !== 'word') return;
        
        t.selected = !t.selected;
        const el = document.getElementById(`t-${idx}`);
        
        if (t.selected) el.classList.add('selected');
        else el.classList.remove('selected');
    }

    // í† í°ì„ ë‹¤ì‹œ í…ìŠ¤íŠ¸ë¡œ ì¡°ë¦½
    function constructText() {
        return tokens.map(t => {
            if (t.type === 'word' && t.selected) return `{${t.text}}`;
            return t.text;
        }).join('');
    }

    function saveCard() {
        const final = constructText();
        document.getElementById('final_content').value = final;
        document.getElementById('save-form').submit();
    }
</script>
{% endblock %}
