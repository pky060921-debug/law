{% extends "layout.html" %}

{% block content %}

{% macro card_block(item, my_completed) %}
<div class="card-item">
    <div style="display:flex; align-items:center; flex:1; overflow:hidden;">
        <input type="checkbox" name="merge_targets" value="{{ item.get('quest_name') }}" style="margin-right:10px; cursor:pointer; transform:scale(1.2);">
        <span style="color:#ecf0f1; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="{{ item.get('quest_name') }}">
            {% if item.get('quest_name') in my_completed %}
                <span style="color:#2ecc71; margin-right:3px;">âœ…</span>
            {% elif '{' in item.get('content', '') %}
                <span style="color:#3498db; margin-right:3px;">ğŸ”¨</span>
            {% endif %}
            {{ item.get('quest_name', '').split('-')[-1] }}
        </span>
    </div>
    <div style="display:flex; gap:5px; margin-left:5px;">
        <button type="submit" name="delete_single" value="{{ item.get('quest_name') }}" style="background:none; border:none; cursor:pointer; font-size:1rem; padding:0;" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ğŸ—‘ï¸</button>
        <a href="/maker?quest_name={{ item.get('quest_name') }}" style="text-decoration:none;">
            <button type="button" style="background:#2ecc71; color:white; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:0.8rem;">ğŸ“</button>
        </a>
    </div>
</div>
{% endmacro %}

<style>
    .law-table {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
    }
    .law-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        background: #253342;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #34495e;
    }
    .law-header {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 5px;
        color: #bdc3c7;
        margin-top: 10px;
    }
    .col-empty {
        background: rgba(0,0,0,0.2);
        border-radius: 5px;
        border: 1px dashed #444;
        min-height: 40px;
    }
    .card-item {
        background: #34495e;
        padding: 8px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #444;
        transition: 0.2s;
    }
    .card-item:hover { border-color: #f39c12; }

    details {
        margin-bottom: 20px;
        background: #2c3e50;
        border-radius: 10px;
        border: 1px solid #444;
        overflow: hidden;
    }
    summary {
        padding: 15px;
        cursor: pointer;
        font-weight: bold;
        color: #ecf0f1;
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    summary:hover { background: #34495e; }

    @media (max-width: 768px) {
        .law-row { grid-template-columns: 1fr; gap: 5px; }
        .law-header { display: none; }
        .col-empty { display: none; }
    }
</style>

<h1>ğŸ­ ë¹ˆì¹¸ ì¹´ë“œ ìƒì„±ì†Œ</h1>
<p style="color:#aaa; text-align:center;">ì—…ë¡œë“œí•œ ë²•ë ¹ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ë¹ˆì¹¸ì„ ë§Œë“œì„¸ìš”.</p>

<div style="background:#34495e; padding:20px; border-radius:15px; margin-top:20px; text-align:center; border: 1px solid #7f8c8d;">
    <form method="POST" enctype="multipart/form-data" style="display:flex; flex-direction:column; align-items:center;">
        <h3 style="margin-top:0; color:#f39c12;">ğŸ“‚ ìƒˆ íŒŒì¼ ì—…ë¡œë“œ</h3>
        <input type="text" name="new_q_name" placeholder="ë²•ë ¹ ì œëª© (ì˜ˆ: í˜•ë²•)" required 
               style="padding:10px; width:80%; max-width:400px; margin-bottom:10px; border-radius:5px; border:none;">
        <input type="file" name="new_q_file" accept=".txt,.html" required style="color:white; margin-bottom:10px;">
        <button type="submit" style="background:#f39c12; border:none; padding:10px 30px; border-radius:5px; font-weight:bold; cursor:pointer;">
            ìƒì„±í•˜ê¸°
        </button>
    </form>
</div>

<form method="POST" id="main-list-form" style="margin-top:40px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3>ğŸ“‚ ë“±ë¡ëœ ë²•ë ¹ ëª©ë¡</h3>
        <button type="submit" name="merge_targets" value="merge" style="background:#8e44ad; color:white; border:none; padding:8px 15px; border-radius:5px; font-weight:bold; cursor:pointer;" onclick="return confirm('ì„ íƒí•œ ì¹´ë“œë“¤ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            ğŸ”— ì„ íƒ í•©ì¹˜ê¸°
        </button>
    </div>
    
    {% if not aligned_structure and not others %}
        <div style="text-align:center; padding:40px; color:#95a5a6; border: 2px dashed #555; border-radius: 10px;">
            <p>ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    {% else %}
        
        {% for law_name, rows in aligned_structure.items() %}
        <details open>
            <summary>
                <span>ğŸ“‚ {{ law_name }} <span style="color:#bdc3c7; font-size:0.8em;">({{ rows|length }}ê°œ ì¡°ë¬¸)</span></span>
                <button type="submit" name="delete_group" value="{{ law_name }}" style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem;" onclick="return confirm('ì •ë§ \'' + '{{ law_name }}' + '\' ê·¸ë£¹ ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ê·¸ë£¹ ì‚­ì œ ğŸ—‘ï¸</button>
            </summary>
            
            <div style="padding:15px; border-top:1px solid #444; background:#222f3e;">
                <div class="law-header">
                    <div style="color:#3498db;">âš–ï¸ ë²•ë¥ </div>
                    <div style="color:#e67e22;">ğŸ“œ ì‹œí–‰ë ¹</div>
                    <div style="color:#2ecc71;">ğŸ“ ì‹œí–‰ê·œì¹™</div>
                </div>

                <div class="law-table">
                    {% for group in rows %}
                    <div class="law-row">
                        {% if group['law'] %}{{ card_block(group['law'], my_completed) }}{% else %}<div class="col-empty"></div>{% endif %}
                        {% if group['decree'] %}{{ card_block(group['decree'], my_completed) }}{% else %}<div class="col-empty"></div>{% endif %}
                        {% if group['rule'] %}{{ card_block(group['rule'], my_completed) }}{% else %}<div class="col-empty"></div>{% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </details>
        {% endfor %}

        {% if others %}
        <div style="margin-top:30px; border-top:1px dashed #555; padding-top:20px;">
            <h4 style="color:#bdc3c7; text-align:center;">ğŸ“‚ ê¸°íƒ€ ë¬¸ì„œ</h4>
            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:10px;">
                {% for item in others %}
                    {{ card_block(item, my_completed) }}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endif %}
</form>
{% endblock %}
