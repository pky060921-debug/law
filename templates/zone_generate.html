{% extends "layout.html" %}

{% block content %}
<h1>ğŸ­ ë¹ˆì¹¸ ì¹´ë“œ ìƒì„±ì†Œ</h1>
<p style="color:#aaa; text-align:center;">ì—…ë¡œë“œí•œ ë²•ë ¹ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ë¹ˆì¹¸ì„ ë§Œë“œì„¸ìš”.</p>

<div style="background:#34495e; padding:20px; border-radius:15px; margin-top:20px; text-align:center; border: 1px solid #7f8c8d;">
    <form method="POST" enctype="multipart/form-data" style="display:flex; flex-direction:column; align-items:center;">
        <h3 style="margin-top:0; color:#f39c12;">ğŸ“‚ ìƒˆ íŒŒì¼ ì—…ë¡œë“œ</h3>
        <input type="text" name="new_q_name" placeholder="ë²•ë ¹ ì œëª© (ì˜ˆ: í˜•ë²•)" required 
               style="padding:10px; width:80%; max-width:400px; margin-bottom:10px; border-radius:5px; border:none;">
        <input type="file" name="new_q_file" accept=".txt" required style="color:white; margin-bottom:10px;">
        <button type="submit" style="background:#f39c12; border:none; padding:10px 30px; border-radius:5px; font-weight:bold; cursor:pointer;">
            ìƒì„±í•˜ê¸°
        </button>
    </form>
</div>

<div style="margin-top:40px;">
    <h3>ğŸ“‚ ë“±ë¡ëœ ë²•ë ¹ ëª©ë¡</h3>
    
    {% if not quests %}
        <div style="text-align:center; padding:40px; color:#95a5a6; border: 2px dashed #555; border-radius: 10px;">
            <p>ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    {% else %}
        {% set groups = {} %}
        {% for q in quests %}
            {% set title = q.get('quest_name', '').split('-')[0] %}
            {% if title not in groups %}{% set _ = groups.update({title: []}) %}{% endif %}
            {% set _ = groups[title].append(q) %}
        {% endfor %}

        {% for title, items in groups.items() %}
        <details style="margin-bottom:15px; background:#2c3e50; border-radius:10px; border:1px solid #444; overflow:hidden;">
            <summary style="padding:15px; cursor:pointer; font-weight:bold; color:#ecf0f1; list-style:none; display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ“‚ {{ title }} <span style="color:#bdc3c7; font-size:0.8em;">({{ items|length }}ê°œ)</span></span>
                <span style="font-size:0.8em; color:#f39c12;">â–¼ í¼ì¹˜ê¸°</span>
            </summary>
            
            <div style="background:#34495e; padding:10px; border-top:1px solid #444;">
                <div style="text-align:right; margin-bottom:10px;">
                    <form method="POST" style="display:inline;" onsubmit="return confirm('ì •ë§ \'' + '{{ title }}' + '\' ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <input type="hidden" name="delete_group" value="{{ title }}">
                        <button style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.9rem;">
                            ê·¸ë£¹ ì „ì²´ ì‚­ì œ ğŸ—‘ï¸
                        </button>
                    </form>
                </div>

                {% for item in items %}
                <div style="padding:10px; border-bottom:1px solid #555;">
                    <div id="disp-{{ loop.index }}" style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:#ecf0f1; font-size:0.95rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right:10px; flex:1;">
                            {% if item.get('quest_name') in my_completed %}
                                <span style="color:#2ecc71; font-weight:bold;">[âœ… íšë“ì™„ë£Œ]</span>
                            {% endif %}
                            {{ item.get('quest_name', '').split('-')[-1] }}
                        </span>
                        
                        <div>
                            <button type="button" onclick="toggleEdit('{{ loop.index }}')" style="background:#95a5a6; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; font-size:0.8rem; margin-right:5px;">
                                âœï¸ì´ë¦„ë³€ê²½
                            </button>
                            <a href="/maker?quest_name={{ item.get('quest_name') }}" style="text-decoration:none;">
                                <button style="background:#2ecc71; color:white; border:none; padding:5px 12px; border-radius:5px; cursor:pointer; font-size:0.9rem;">
                                    ğŸ“ ë¹ˆì¹¸
                                </button>
                            </a>
                        </div>
                    </div>

                    <div id="edit-{{ loop.index }}" style="display:none; margin-top:5px; background:#222; padding:10px; border-radius:5px;">
                        <form method="POST" style="display:flex; gap:5px;">
                            <input type="hidden" name="rename_old" value="{{ item.get('quest_name') }}">
                            <input type="text" name="rename_new" value="{{ item.get('quest_name') }}" 
                                   style="flex:1; padding:5px; border:1px solid #555; background:#333; color:white; border-radius:3px;">
                            <button type="submit" style="background:#3498db; border:none; color:white; padding:5px 10px; border-radius:3px; cursor:pointer;">ì €ì¥</button>
                            <button type="button" onclick="toggleEdit('{{ loop.index }}')" style="background:#e74c3c; border:none; color:white; padding:5px 10px; border-radius:3px; cursor:pointer;">ì·¨ì†Œ</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </details>
        {% endfor %}
    {% endif %}
</div>

<script>
    function toggleEdit(id) {
        const disp = document.getElementById('disp-' + id);
        const edit = document.getElementById('edit-' + id);
        if (edit.style.display === 'none') {
            edit.style.display = 'block';
            disp.style.display = 'none';
        } else {
            edit.style.display = 'none';
            disp.style.display = 'flex';
        }
    }
</script>
{% endblock %}
