{% extends "layout.html" %}

{% block content %}

{% macro card_block(item, my_completed) %}
<div class="card-item">
    <div style="display:flex; align-items:center; flex:1; overflow:hidden;">
        <input type="checkbox" name="merge_targets" value="{{ item.get('quest_name') }}" style="margin-right:10px; cursor:pointer; transform:scale(1.2);">
        
        <span style="color:#ecf0f1; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:default;" title="{{ item.get('quest_name') }}">
            {% if item.get('quest_name') in my_completed %}
                <span style="color:#2ecc71; margin-right:3px;">âœ…</span>
            {% elif '{' in item.get('content', '') %}
                <span style="color:#3498db; margin-right:3px;">ğŸ”¨</span>
            {% endif %}
            
            {{ item.get('quest_name', '').split('-')[-1] }}
        </span>
    </div>
    
    <div style="display:flex; gap:5px; margin-left:5px;">
        <button type="submit" name="delete_single" value="{{ item.get('quest_name') }}" style="background:none; border:none; cursor:pointer; font-size:1rem; padding:0;" onclick="return confirm('ì´ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ğŸ—‘ï¸</button>
        <a href="/maker?quest_name={{ item.get('quest_name') }}" style="text-decoration:none;">
            <button type="button" style="background:#2ecc71; color:white; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:0.8rem;">ğŸ“</button>
        </a>
    </div>
</div>
{% endmacro %}


<h1>ğŸ­ ë¹ˆì¹¸ ì¹´ë“œ ìƒì„±ì†Œ</h1>
<p style="color:#aaa; text-align:center;">ì—…ë¡œë“œí•œ ë²•ë ¹ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ë¹ˆì¹¸ì„ ë§Œë“œì„¸ìš”.</p>

<div style="background:#34495e; padding:20px; border-radius:15px; margin-top:20px; text-align:center; border: 1px solid #7f8c8d;">
    <form method="POST" enctype="multipart/form-data" style="display:flex; flex-direction:column; align-items:center;">
        <h3 style="margin-top:0; color:#f39c12;">ğŸ“‚ ìƒˆ íŒŒì¼ ì—…ë¡œë“œ</h3>
        <input type="text" name="new_q_name" placeholder="ë²•ë ¹ ì œëª© (ì˜ˆ: í˜•ë²•)" required 
               style="padding:10px; width:80%; max-width:400px; margin-bottom:10px; border-radius:5px; border:none;">
        <input type="file" name="new_q_file" accept=".txt,.html" required style="color:white; margin-bottom:10px;">
        <button type="submit" style="background:#f39c12; border:none; padding:10px 30px; border-radius:5px; font-weight:bold; cursor:pointer;">
            ìƒì„±í•˜ê¸°
        </button>
    </form>
</div>

<form method="POST" id="main-list-form" style="margin-top:40px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3>ğŸ“‚ ë“±ë¡ëœ ë²•ë ¹ ëª©ë¡</h3>
        <button type="submit" name="merge_targets" value="merge" style="background:#8e44ad; color:white; border:none; padding:8px 15px; border-radius:5px; font-weight:bold; cursor:pointer;" onclick="return confirm('ì„ íƒí•œ ì¹´ë“œë“¤ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            ğŸ”— ì„ íƒ í•©ì¹˜ê¸°
        </button>
    </div>
    
    {% if not quests %}
        <div style="text-align:center; padding:40px; color:#95a5a6; border: 2px dashed #555; border-radius: 10px;">
            <p>ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    {% else %}
        {% set groups = {} %}
        {% for q in quests %}
            {% set title = q.get('quest_name', '').split('-')[0] %}
            {% if title not in groups %}{% set _ = groups.update({title: []}) %}{% endif %}
            {% set _ = groups[title].append(q) %}
        {% endfor %}

        {% for title, items in groups.items() %}
        <details style="margin-bottom:15px; background:#2c3e50; border-radius:10px; border:1px solid #444; overflow:hidden;">
            <summary style="padding:15px; cursor:pointer; font-weight:bold; color:#ecf0f1; list-style:none; display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ“‚ {{ title }} <span style="color:#bdc3c7; font-size:0.8em;">({{ items|length }}ê°œ)</span></span>
                <span style="font-size:0.8em; color:#f39c12;">â–¼ í¼ì¹˜ê¸°</span>
            </summary>
            
            <div style="background:#34495e; padding:10px; border-top:1px solid #444;">
                <div style="text-align:right; margin-bottom:10px;">
                    <button type="submit" name="delete_group" value="{{ title }}" style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.9rem;" onclick="return confirm('ì •ë§ \'' + '{{ title }}' + '\' ê·¸ë£¹ ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        ê·¸ë£¹ ì „ì²´ ì‚­ì œ ğŸ—‘ï¸
                    </button>
                </div>

                {% set laws = [] %}{% set decrees = [] %}{% set rules = [] %}{% set others = [] %}
                
                {% for item in items %}
                    {% if item.get('quest_name').startswith('ì œ-') %}
                        {% set _ = laws.append(item) %}
                    {% elif item.get('quest_name').startswith('ë ¹-') %}
                        {% set _ = decrees.append(item) %}
                    {% elif item.get('quest_name').startswith('ê·œ-') %}
                        {% set _ = rules.append(item) %}
                    {% else %}
                        {% set _ = others.append(item) %}
                    {% endif %}
                {% endfor %}

                <div class="law-board">
                    <div class="law-column col-law">
                        <h4>âš–ï¸ ë²•ë¥  ({{ laws|length }})</h4>
                        {% for item in laws %}
                            {{ card_block(item, my_completed) }}
                        {% endfor %}
                    </div>

                    <div class="law-column col-decree">
                        <h4>ğŸ“œ ì‹œí–‰ë ¹ ({{ decrees|length }})</h4>
                        {% for item in decrees %}
                            {{ card_block(item, my_completed) }}
                        {% endfor %}
                    </div>

                    <div class="law-column col-rule">
                        <h4>ğŸ“ ì‹œí–‰ê·œì¹™ ({{ rules|length }})</h4>
                        {% for item in rules %}
                            {{ card_block(item, my_completed) }}
                        {% endfor %}
                    </div>
                </div>

                {% if others %}
                <div style="margin-top:15px; border-top:1px dashed #555; padding-top:10px;">
                    <h4 style="color:#bdc3c7; text-align:center;">ê¸°íƒ€ ë¬¸ì„œ</h4>
                    {% for item in others %}
                        {{ card_block(item, my_completed) }}
                    {% endfor %}
                </div>
                {% endif %}

            </div>
        </details>
        {% endfor %}
    {% endif %}
</form>

<style>
    /* 3ë‹¨ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
    .law-board {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        margin-top: 10px;
    }
    
    .law-column {
        background: #253342;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #34495e;
    }

    .law-column h4 {
        text-align: center;
        margin: 0 0 10px 0;
        padding-bottom: 5px;
        border-bottom: 2px solid #555;
        font-size: 1rem;
    }

    .col-law h4 { color: #3498db; border-color: #3498db; }
    .col-decree h4 { color: #e67e22; border-color: #e67e22; }
    .col-rule h4 { color: #2ecc71; border-color: #2ecc71; }

    .card-item {
        background: #34495e;
        padding: 8px;
        margin-bottom: 8px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #444;
        transition: 0.2s;
    }
    .card-item:hover { border-color: #f39c12; }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
        .law-board { grid-template-columns: 1fr; }
        .law-column { margin-bottom: 15px; }
    }
</style>
{% endblock %}
