{% extends "layout.html" %}

{% block content %}
<style>
    /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .card {
        background: #ecf0f1;
        color: #2c3e50;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        position: relative;
        border-bottom: 5px solid #bdc3c7;
        transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-5px); }

    /* ë“±ê¸‰ë³„ ìŠ¤íƒ€ì¼ */
    .card.NORMAL { border-top: 5px solid #95a5a6; }
    .card.RARE { border-top: 5px solid #3498db; background: #eaf2f8; }
    .card.LEGEND { border-top: 5px solid #f1c40f; background: #fcf3cf; }

    .grade-badge {
        font-size: 0.8rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 10px;
        display: inline-block;
        margin-bottom: 10px;
        color: white;
    }
    .NORMAL .grade-badge { background: #95a5a6; }
    .RARE .grade-badge { background: #3498db; }
    .LEGEND .grade-badge { background: #f1c40f; color: #333; }

    /* êµí™˜ ë²„íŠ¼ */
    .btn-exchange {
        width: 100%;
        margin-top: 10px;
        padding: 8px;
        border: none;
        border-radius: 5px;
        background: #e67e22;
        color: white;
        font-family: 'Do Hyeon';
        cursor: pointer;
        transition: 0.2s;
    }
    .btn-exchange:hover { background: #d35400; }

    /* í¬ì¸íŠ¸ ì •ë³´ */
    .my-points {
        text-align: right;
        font-size: 1.5rem;
        color: #f1c40f;
        margin-bottom: 10px;
        text-shadow: 1px 1px 0 #000;
    }
</style>

<h1>ğŸƒ ì¹´ë“œ êµí™˜ì†Œ</h1>
<div class="my-points">
    ë‚´ ì§€ê°‘: <span id="current-points">{{ points }}</span> P
</div>
<p style="text-align:center; color:#bdc3c7;">
    ëª¨ì€ ì¹´ë“œë¥¼ í¬ì¸íŠ¸ë¡œ êµí™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
    (ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ì¹´ë“œì˜ ê°€ì¹˜ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤!)
</p>

{% if cards %}
<div class="card-grid">
    {% for card in cards %}
    <div class="card {{ card.grade }}" id="card-{{ loop.index }}">
        <span class="grade-badge">{{ card.grade }}</span>
        <div style="font-size: 1.2rem; font-weight: bold; margin: 10px 0; min-height: 50px; display:flex; align-items:center; justify-content:center;">
            {{ card.card_text }}
        </div>
        <div style="color: #7f8c8d; font-size: 0.9rem;">
            ë³´ìœ ëŸ‰: <b id="count-{{ loop.index }}">{{ card.count }}</b>ì¥
        </div>
        
        <button class="btn-exchange" onclick="exchangeCard('{{ card.card_text }}', {{ loop.index }})">
            ğŸ’° êµí™˜í•˜ê¸°
        </button>
    </div>
    {% endfor %}
</div>
{% else %}
<div style="text-align:center; padding:50px; color:#95a5a6;">
    ì•„ì§ íšë“í•œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.<br>
    ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ì—¬ ì¹´ë“œë¥¼ ëª¨ìœ¼ì„¸ìš”!
</div>
{% endif %}

<script>
    function exchangeCard(cardText, index) {
        if(!confirm(`'${cardText}' ì¹´ë“œë¥¼ í¬ì¸íŠ¸ë¡œ êµí™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        fetch('/exchange', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ card_text: cardText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // UI ì—…ë°ì´íŠ¸
                alert(`êµí™˜ ì„±ê³µ! +${data.earned} í¬ì¸íŠ¸ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
                document.getElementById('current-points').innerText = data.new_total;
                
                // ìˆ˜ëŸ‰ ê°ì†Œ ì²˜ë¦¬
                const countEl = document.getElementById(`count-${index}`);
                let currentCount = parseInt(countEl.innerText);
                currentCount--;
                
                if (currentCount <= 0) {
                    // ì¹´ë“œ ì œê±°
                    document.getElementById(`card-${index}`).remove();
                } else {
                    countEl.innerText = currentCount;
                }
            } else {
                alert('êµí™˜ ì‹¤íŒ¨: ' + data.msg);
            }
        })
        .catch(err => {
            console.error(err);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
</script>
{% endblock %}
